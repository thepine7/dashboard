<!-- eb87f7b6-6d1e-4fb6-bf0a-fa6dddf48fa5 b86cc81e-e0c3-4aa9-a8ba-32d17af7de4b -->
# 엑셀 다운로드 코드 리팩토링 계획

## 1. 날짜 형식 변환 유틸리티 메서드 추가

DataController 클래스 내부에 private 메서드 생성:

```java
/**
 * YYYYMMDD 형식을 YYYY-MM-DD 형식으로 변환
 */
private String convertDateFormat(String dateStr) {
    if (dateStr == null || dateStr.isEmpty()) {
        return null;
    }
    
    // 이미 YYYY-MM-DD 형식이면 그대로 반환
    if (dateStr.contains("-")) {
        return dateStr;
    }
    
    // YYYYMMDD -> YYYY-MM-DD 변환
    if (dateStr.length() >= 8) {
        return dateStr.substring(0, 4) + "-" + 
               dateStr.substring(4, 6) + "-" + 
               dateStr.substring(6, 8);
    }
    
    return dateStr;
}

/**
 * YYYY-MM-DD 형식을 YYYYMMDD 형식으로 변환
 */
private String removeDateHyphens(String dateStr) {
    if (dateStr == null || dateStr.isEmpty()) {
        return null;
    }
    return dateStr.replace("-", "");
}
```

## 2. excelDownload 메서드 리팩토링

### 2.1 파라미터 추출 및 검증 (247-307번 줄)

현재 코드 유지, 로깅 간소화

### 2.2 날짜 파라미터 처리 로직 재구성 (309-427번 줄)

현재 문제점:

- 316-343번 줄: 들여쓰기가 잘못되어 if 블록 내부에 있음
- 399-427번 줄: 중복된 날짜 변환 로직

리팩토링 후:

```java
// 세션 검증 통과 후 바로 실행
if (null != session) {
    if (null != sessionUserId && !"".equals(sessionUserId) && 
        null != sensorId && !"".equals(sensorId) && 
        null != sensorUuid && !"".equals(sensorUuid)) {
        
        // === 1. 날짜 파라미터 정리 ===
        String todayStr;
        String setDate1;
        String setDate2;
        
        if (null != setDate && !"".equals(setDate) && setDate.length() > 0) {
            // setDate 사용 (하위 호환성)
            todayStr = setDate;
            String dateWithoutHyphens = removeDateHyphens(setDate);
            setDate1 = dateWithoutHyphens + "000000";
            setDate2 = dateWithoutHyphens + "235959";
        } else {
            // startDate/endDate 사용 (현재 방식)
            Date today = new Date();
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
            todayStr = sdf.format(today);
            
            if (startDate != null && !startDate.isEmpty()) {
                String dateWithoutHyphens = removeDateHyphens(startDate);
                setDate1 = dateWithoutHyphens + "000000";
            } else {
                setDate1 = "";
            }
            
            if (endDate != null && !endDate.isEmpty()) {
                String dateWithoutHyphens = removeDateHyphens(endDate);
                setDate2 = dateWithoutHyphens + "235959";
            } else {
                setDate2 = "";
            }
        }
        
        logger.info("날짜 파라미터 처리 완료 - todayStr: {}, setDate1: {}, setDate2: {}", 
            todayStr, setDate1, setDate2);
        
        // === 2. 파일 응답 헤더 설정 ===
        String fileName = "report_" + todayStr + ".xlsx";
        String encodedFileName = java.net.URLEncoder.encode(fileName, "UTF-8")
            .replaceAll("\\+", "%20");
        
        res.setHeader("Content-Disposition", 
            "attachment; filename=\"" + fileName + "\"; filename*=UTF-8''" + encodedFileName);
        res.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        res.setCharacterEncoding("UTF-8");
        res.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
        res.setHeader("Pragma", "no-cache");
        res.setHeader("Expires", "0");
        res.setHeader("X-Content-Type-Options", "nosniff");
        res.setHeader("X-Download-Options", "noopen");
        
        // === 3. 데이터 조회용 파라미터 구성 ===
        Map<String, Object> userInfo = adminService.getUserInfo(sessionUserId, sensorUuid);
        String actualSensorId = sensorId;
        
        if (null != userInfo && userInfo.size() > 0) {
            Map<String, Object> sensor = (Map<String, Object>) userInfo.get("sensorInfo");
            if (null != sensor && sensor.size() > 0) {
                actualSensorId = String.valueOf(sensor.get("sensorId"));
                logger.info("실제 장치 소유자 ID: {}", actualSensorId);
            }
        }
        
        Map<String, Object> param = new HashMap<String, Object>();
        param.put("userId", actualSensorId != null ? actualSensorId : sessionUserId);
        param.put("sensorId", actualSensorId != null ? actualSensorId : sessionUserId);
        param.put("sensorUuid", sensorUuid);
        param.put("setDate", setDate);
        param.put("setDate1", setDate1);
        param.put("setDate2", setDate2);
        
        // === 4. SQL용 YYYY-MM-DD HH:MM:SS 형식 생성 ===
        String finalStartDate = startDate;
        String finalEndDate = endDate;
        
        // startDate가 없으면 setDate1에서 추출
        if (finalStartDate == null || finalStartDate.trim().isEmpty()) {
            if (setDate1 != null && setDate1.length() >= 8) {
                finalStartDate = convertDateFormat(setDate1.substring(0, 8));
            }
        }
        
        // endDate가 없으면 setDate2에서 추출
        if (finalEndDate == null || finalEndDate.trim().isEmpty()) {
            if (setDate2 != null && setDate2.length() >= 8) {
                finalEndDate = convertDateFormat(setDate2.substring(0, 8));
            }
        }
        
        param.put("startDateTime", finalStartDate + " 00:00:00");
        param.put("endDateTime", finalEndDate + " 23:59:59");
        
        logger.info("SQL 조회 파라미터 - startDateTime: {}, endDateTime: {}", 
            finalStartDate + " 00:00:00", finalEndDate + " 23:59:59");
        
        // === 5. 데이터 조회 및 엑셀 생성 ===
        // 기존 로직 유지 (429-522번 줄)
    }
}
```

## 3. 수정 범위

- src/main/java/com/andrew/hnt/api/controller/DataController.java
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 클래스 하단에 유틸리티 메서드 2개 추가 (670번 줄 이후)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - excelDownload 메서드 리팩토링 (309-522번 줄)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 들여쓰기 정리 및 중복 코드 제거
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 로깅 메시지 간소화

## 4. 기대 효과

- 중복 코드 60% 감소
- 들여쓰기 깊이 5단계 → 3단계로 감소
- 날짜 변환 로직 재사용 가능
- 코드 가독성 대폭 향상
- 유지보수 용이성 증가

## 5. 하위 호환성

- setDate 파라미터 지원 유지
- startDate/endDate 파라미터 지원 유지
- 기존 API 호출 방식 변경 없음

### To-dos

- [ ] chart.jsp에 userId hidden input 추가
- [ ] DataController excelDownload 메서드의 파라미터 검증 로직 개선
- [ ] 차트 페이지에서 엑셀 다운로드 기능 테스트 및 검증