package com.andrew.hnt.api.service;

import com.andrew.hnt.api.util.StringUtil;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.auth.oauth2.GoogleCredentials;
import okhttp3.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

/**
 * FCM v1 API ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
 * Legacy HTTP APIì—ì„œ v1 APIë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
 */
@Service
public class FCMService {
    
    private static final Logger logger = LoggerFactory.getLogger(FCMService.class);
    
    @Value("${security.fcm.api-key}")
    private String apiKey;
    
    @Value("${security.fcm.sender-id}")
    private String senderId;
    
    @Value("${security.fcm.project-id}")
    private String projectId;
    
    @Value("${security.fcm.service-account-key-path:}")
    private String serviceAccountKeyPath;
    
    private final OkHttpClient client;
    private final ObjectMapper objectMapper;
    
    public FCMService() {
        this.client = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .readTimeout(30, TimeUnit.SECONDS)
                .writeTimeout(30, TimeUnit.SECONDS)
                .build();
        this.objectMapper = new ObjectMapper();
    }
    
    /**
     * Spring Bean ì´ˆê¸°í™” í›„ ì‹¤í–‰ë˜ëŠ” ë©”ì„œë“œ
     * @Value ê°’ë“¤ì´ ì£¼ì…ëœ í›„ ì‹¤í–‰ë¨
     */
    @PostConstruct
    public void init() {
        // í†°ìº£ ì„œë²„ ì½˜ì†”ì— FCM ë¡œê·¸ ëª…í™•í•˜ê²Œ ì¶œë ¥
        logger.info("===============================================");
        logger.info("ğŸš€ FCM v1 API ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ");
        logger.info("===============================================");
        logger.info("ğŸ“± FCM v1 API ì„¤ì • ì •ë³´:");
        logger.info("   - Project ID: {}", projectId);
        logger.info("   - Service Account Key: {}", serviceAccountKeyPath);
        logger.info("   - Legacy API Key: {}", apiKey != null ? "ì„¤ì •ë¨" : "ì„¤ì •ë˜ì§€ ì•ŠìŒ");
        logger.info("===============================================");
    }
    
    /**
     * FCM v1 APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì•Œë¦¼ ì „ì†¡
     * @param token ë””ë°”ì´ìŠ¤ í† í°
     * @param title ì•Œë¦¼ ì œëª©
     * @param body ì•Œë¦¼ ë‚´ìš©
     * @param data ì¶”ê°€ ë°ì´í„°
     * @return ì „ì†¡ ì„±ê³µ ì—¬ë¶€
     */
    public boolean sendNotification(String token, String title, String body, Map<String, String> data) {
        try {
            // í†°ìº£ ì„œë²„ì— FCM ì „ì†¡ ì‹œì‘ ë¡œê·¸ ì¶œë ¥
            logger.info("===============================================");
            logger.info("ğŸš€ FCM v1 API ì „ì†¡ ì‹œì‘");
            logger.info("   - ë””ë°”ì´ìŠ¤ í† í°: {}...", token.substring(0, Math.min(token.length(), 20)));
            logger.info("   - ì•Œë¦¼ ì œëª©: {}", title);
            logger.info("   - ì•Œë¦¼ ë‚´ìš©: {}", body);
            logger.info("   - ì¶”ê°€ ë°ì´í„°: {}", data != null ? data.size() + "ê°œ" : "ì—†ìŒ");
            logger.info("===============================================");
            
            // FCM v1 API ìš”ì²­ ë³¸ë¬¸ êµ¬ì„±
            Map<String, Object> requestBody = new HashMap<>();
            Map<String, Object> message = new HashMap<>();
            
            message.put("token", token);
            
            // ì•Œë¦¼ ì„¤ì •
            Map<String, String> notification = new HashMap<>();
            notification.put("title", title);
            notification.put("body", body);
            message.put("notification", notification);
            
            // ë°ì´í„° ì„¤ì •
            if (data != null && !data.isEmpty()) {
                message.put("data", data);
            }
            
            requestBody.put("message", message);
            
            // JSON ë³€í™˜
            String jsonBody = objectMapper.writeValueAsString(requestBody);
            
            // í†°ìº£ ì„œë²„ì— ìš”ì²­ ë³¸ë¬¸ ë¡œê·¸ ì¶œë ¥
            logger.info("===============================================");
            logger.info("ğŸ“‹ FCM v1 API ìš”ì²­ ë³¸ë¬¸ ìƒì„± ì™„ë£Œ");
            logger.info("   - ìš”ì²­ URL: https://fcm.googleapis.com/v1/projects/{}/messages:send", projectId);
            logger.info("   - ìš”ì²­ ë³¸ë¬¸: {}", jsonBody);
            logger.info("===============================================");
            
            // HTTP ìš”ì²­ ìƒì„±
            RequestBody body1 = RequestBody.create(jsonBody, MediaType.parse("application/json"));
            
            Request request = new Request.Builder()
                    .url("https://fcm.googleapis.com/v1/projects/" + projectId + "/messages:send")
                    .addHeader("Authorization", "Bearer " + getAuthToken())
                    .addHeader("Content-Type", "application/json")
                    .post(body1)
                    .build();
            
            // í†°ìº£ ì„œë²„ì— HTTP ìš”ì²­ ì „ì†¡ ë¡œê·¸ ì¶œë ¥
            logger.info("===============================================");
            logger.info("ğŸŒ FCM v1 API HTTP ìš”ì²­ ì „ì†¡");
            logger.info("   - ìš”ì²­ í—¤ë”: Authorization: Bearer ***, Content-Type: application/json");
            logger.info("   - ìš”ì²­ ë©”ì„œë“œ: POST");
            logger.info("===============================================");
            
            // ìš”ì²­ ì „ì†¡
            try (Response response = client.newCall(request).execute()) {
                if (response.isSuccessful()) {
                    String responseBody = response.body() != null ? response.body().string() : "";
                    logger.info("===============================================");
                    logger.info("âœ… FCM v1 API ì „ì†¡ ì„±ê³µ!");
                    logger.info("   - ì‘ë‹µ ì½”ë“œ: {}", response.code());
                    logger.info("   - ì‘ë‹µ ë‚´ìš©: {}", responseBody);
                    logger.info("   - í† í°: {}...", token.substring(0, Math.min(token.length(), 20)));
                    logger.info("   - ì œëª©: {}", title);
                    logger.info("   - ì „ì†¡ ì‹œê°„: {}", java.time.LocalDateTime.now());
                    logger.info("===============================================");
                    return true;
                } else {
                    String responseBody = response.body() != null ? response.body().string() : "";
                    logger.error("===============================================");
                    logger.error("âŒ FCM v1 API ì „ì†¡ ì‹¤íŒ¨!");
                    logger.error("   - ì‘ë‹µ ì½”ë“œ: {}", response.code());
                    logger.error("   - ì‘ë‹µ ë‚´ìš©: {}", responseBody);
                    logger.error("   - í† í°: {}...", token.substring(0, Math.min(token.length(), 20)));
                    logger.error("   - ì‹¤íŒ¨ ì‹œê°„: {}", java.time.LocalDateTime.now());
                    logger.error("===============================================");
                    return false;
                }
            }
            
        } catch (Exception e) {
            logger.error("===============================================");
            logger.error("ğŸ’¥ FCM v1 API ì „ì†¡ ì¤‘ ì˜ˆì™¸ ë°œìƒ!");
            logger.error("   - ì˜ˆì™¸ íƒ€ì…: {}", e.getClass().getSimpleName());
            logger.error("   - ì˜ˆì™¸ ë©”ì‹œì§€: {}", e.getMessage());
            logger.error("   - ë°œìƒ ì‹œê°„: {}", java.time.LocalDateTime.now());
            logger.error("   - ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:", e);
            logger.error("===============================================");
            return false;
        }
    }
    
    /**
     * ì„¼ì„œ ì•Œë¦¼ ì „ì†¡ (ê¸°ì¡´ sendNoti ë©”ì„œë“œì™€ í˜¸í™˜)
     * @param noti ì•Œë¦¼ ì •ë³´
     * @return ì „ì†¡ ì„±ê³µ ì—¬ë¶€
     */
    public boolean sendSensorNotification(Map<String, Object> noti) {
        if (noti == null || noti.isEmpty()) {
            return false;
        }
        
        try {
            String token = String.valueOf(noti.get("token"));
            String sensorUuid = String.valueOf(noti.get("sensor_uuid"));
            String gu = String.valueOf(noti.get("gu"));
            String inTemp = String.valueOf(noti.get("inTemp"));
            String curTemp = String.valueOf(noti.get("curTemp"));
            String inType = String.valueOf(noti.get("inType"));
            
            // í†°ìº£ ì„œë²„ì— ì„¼ì„œ ì•Œë¦¼ ì „ì†¡ ë¡œê·¸ ì¶œë ¥
            logger.info("===============================================");
            logger.info("ğŸ“± ì„¼ì„œ ì•Œë¦¼ ì „ì†¡ ì‹œì‘");
            logger.info("   - ì„¼ì„œ UUID: {}", sensorUuid);
            logger.info("   - ì•Œë¦¼ ìœ í˜•: {}", gu);
            logger.info("   - ì„¤ì • ì˜¨ë„: {}Â°C", curTemp);
            logger.info("   - í˜„ì¬ ì˜¨ë„: {}Â°C", inTemp);
            logger.info("   - ì…ë ¥ íƒ€ì…: {}", inType);
            logger.info("===============================================");
            
            // ì•Œë¦¼ ì œëª©ê³¼ ë‚´ìš© ìƒì„±
            String title = "ì„¼ì„œ ì•Œë¦¼";
            String body = generateNotificationBody(gu, inTemp, curTemp, inType, sensorUuid);
            
            // ì¶”ê°€ ë°ì´í„° ì„¤ì •
            Map<String, String> data = new HashMap<>();
            data.put("sensor_uuid", sensorUuid);
            data.put("type", gu);
            data.put("message", body);
            data.put("timestamp", String.valueOf(System.currentTimeMillis()));
            
            return sendNotification(token, title, body, data);
            
        } catch (Exception e) {
            logger.error("===============================================");
            logger.error("ğŸ’¥ ì„¼ì„œ ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜ˆì™¸ ë°œìƒ!");
            logger.error("   - ì˜ˆì™¸ íƒ€ì…: {}", e.getClass().getSimpleName());
            logger.error("   - ì˜ˆì™¸ ë©”ì‹œì§€: {}", e.getMessage());
            logger.error("   - ì„¼ì„œ UUID: {}", noti.get("sensor_uuid"));
            logger.error("   - ì•Œë¦¼ ìœ í˜•: {}", noti.get("gu"));
            logger.error("   - ë°œìƒ ì‹œê°„: {}", java.time.LocalDateTime.now());
            logger.error("   - ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:", e);
            logger.error("===============================================");
            return false;
        }
    }
    
    /**
     * ì•Œë¦¼ ë‚´ìš© ìƒì„±
     */
    private String generateNotificationBody(String gu, String inTemp, String curTemp, String inType, String sensorUuid) {
        StringBuilder body = new StringBuilder();
        body.append(sensorUuid).append("ì¥ì¹˜ ");
        
        if ("ain".equals(gu)) {
            if ("high".equals(inType)) {
                body.append("ì˜¨ë„ ë†’ìŒ(ì„¤ì •ì˜¨ë„: ").append(curTemp).append("Â°C, í˜„ì¬ì˜¨ë„: ").append(inTemp).append("Â°C)");
            } else if ("low".equals(inType)) {
                body.append("ì˜¨ë„ ë‚®ìŒ(ì„¤ì •ì˜¨ë„: ").append(curTemp).append("Â°C, í˜„ì¬ì˜¨ë„: ").append(inTemp).append("Â°C)");
            }
        } else if ("din".equals(gu)) {
            body.append("DIì•ŒëŒ(ì—ëŸ¬, í˜„ì¬ì˜¨ë„: ").append(inTemp).append("Â°C)");
        } else if ("netError".equals(gu)) {
            body.append("í†µì‹ ì—ëŸ¬");
        } else {
            body.append("ì´ìƒ ë°œìƒ");
        }
        
        return body.toString();
    }
    
    /**
     * OAuth 2.0 ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
     * @return ì•¡ì„¸ìŠ¤ í† í° ë˜ëŠ” null
     */
    private String getAccessToken() {
        try {
            if (StringUtil.isEmpty(serviceAccountKeyPath)) {
                logger.warn("===============================================");
                logger.warn("âš ï¸ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ê²½ë¡œê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ");
                logger.warn("   - í™˜ê²½ë³€ìˆ˜ FCM_SERVICE_ACCOUNT_KEY_PATH í™•ì¸ í•„ìš”");
                logger.warn("===============================================");
                return null;
            }
            
            // í†°ìº£ ì„œë²„ì— OAuth 2.0 í† í° ë°œê¸‰ ì‹œì‘ ë¡œê·¸
            logger.info("===============================================");
            logger.info("ğŸ”‘ OAuth 2.0 ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì‹œì‘");
            logger.info("   - ì„œë¹„ìŠ¤ ê³„ì • í‚¤: {}", serviceAccountKeyPath);
            logger.info("===============================================");
            
            // GoogleCredentials ì‚¬ìš©í•˜ì—¬ í† í° ë°œê¸‰
            InputStream inputStream;
            if (serviceAccountKeyPath.startsWith("classpath:")) {
                // classpath ë¦¬ì†ŒìŠ¤ì—ì„œ ì½ê¸°
                String resourcePath = serviceAccountKeyPath.substring("classpath:".length());
                inputStream = getClass().getClassLoader().getResourceAsStream(resourcePath);
                if (inputStream == null) {
                    throw new IOException("ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + resourcePath);
                }
            } else {
                // íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì½ê¸°
                inputStream = new FileInputStream(serviceAccountKeyPath);
            }
            
            GoogleCredentials credentials = GoogleCredentials
                .fromStream(inputStream)
                .createScoped("https://www.googleapis.com/auth/firebase.messaging");
            
            credentials.refreshIfExpired();
            String token = credentials.getAccessToken().getTokenValue();
            
            logger.info("===============================================");
            logger.info("âœ… OAuth 2.0 ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì„±ê³µ!");
            logger.info("   - í† í° ê¸¸ì´: {} ì", token.length());
            logger.info("   - í† í° ì‹œì‘: {}...", token.substring(0, Math.min(token.length(), 20)));
            logger.info("===============================================");
            return token;
            
        } catch (Exception e) {
            logger.error("===============================================");
            logger.error("âŒ OAuth 2.0 ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì‹¤íŒ¨!");
            logger.error("   - ì˜ˆì™¸ íƒ€ì…: {}", e.getClass().getSimpleName());
            logger.error("   - ì˜ˆì™¸ ë©”ì‹œì§€: {}", e.getMessage());
            logger.error("   - ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ê²½ë¡œ: {}", serviceAccountKeyPath);
            logger.error("   - ë°œìƒ ì‹œê°„: {}", java.time.LocalDateTime.now());
            logger.error("   - ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:", e);
            logger.error("===============================================");
            return null;
        }
    }
    
    /**
     * FCM v1 API ì¸ì¦ í† í° ê°€ì ¸ì˜¤ê¸°
     * @return ì¸ì¦ í† í°
     */
    private String getAuthToken() {
        // OAuth 2.0 í† í° ìš°ì„  ì‹œë„
        String oauthToken = getAccessToken();
        if (oauthToken != null) {
            return oauthToken;
        }
        
        // Fallback: Legacy API í‚¤ ì‚¬ìš©
        logger.warn("===============================================");
        logger.warn("ğŸ”„ FCM v1 API â†’ Legacy API ì „í™˜");
        logger.warn("   - OAuth 2.0 í† í° ë°œê¸‰ ì‹¤íŒ¨ë¡œ Legacy API í‚¤ ì‚¬ìš©");
        logger.warn("   - API í‚¤ ê¸¸ì´: {} ì", apiKey != null ? apiKey.length() : 0);
        logger.warn("===============================================");
        return apiKey;
    }
}
