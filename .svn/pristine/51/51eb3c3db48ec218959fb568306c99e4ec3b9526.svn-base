<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="x" uri="http://java.sun.com/jsp/jstl/xml" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>

<!DOCTYPE html>

<html lang="ko" class="">
<head>
  <meta charset="UTF-8">
  <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><![endif]-->
  <title>H&T Solutions</title>
  <link rel="icon" href="/images/hntbi.png" type="image/png">
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="/css/templatemo_main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* 인라인 스타일 최소화 - 성능 향상 */
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
    }
    
    /* 자주 사용되는 스타일을 미리 정의 */
    .navbar-bg { background-color: #ffffff; }
    .content-bg { background-color: #333333; }
    .text-light { color: #f0f8ff; }
    .btn-toggle-bg { background-color: #cccccc; }
    .sidebar-bg { background-color: #afd9ee; }
    
    /* 이미지 최적화 */
    img { max-width: 100%; height: auto; }
    
    /* 폰트 최적화 */
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* 상태표시등 스타일 */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .status-indicator i {
      font-size: 16px;
      color: white;
    }
    .status-indicator.green { background: #4CAF50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
    .status-indicator.gray { background: #9e9e9e; }
    .status-indicator.red { background: #f44336; box-shadow: 0 0 10px rgba(244, 67, 54, 0.3); }
    .status-indicator.active { animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* 아이콘 스타일 */
    .icon-btn {
      display: inline-block;
      padding: 8px;
      margin: 2px;
      border-radius: 5px;
      transition: all 0.3s ease;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-decoration: none;
      color: #fff;
    }
    .icon-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      text-decoration: none;
      color: #fff;
    }
    .icon-btn i {
      font-size: 20px;
      vertical-align: middle;
    }
    .icon-btn img {
      vertical-align: middle;
      border-radius: 2px;
    }
    
    /* 버튼 스타일 강화 */
    .btn-primary {
      background-color: #337ab7;
      border-color: #2e6da4;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
    }
    .btn-primary:hover {
      background-color: #286090;
      border-color: #204d74;
      color: white;
      text-decoration: none;
    }
  </style>
</head>
<body>
<input type="hidden" id="userId" name="userId" value="${userId}">
<input type="hidden" id="loginUserId" name="loginUserId" value="${loginUserId}">
<input type="hidden" id="userGrade" name="userGrade" value="${userGrade}">
<input type="hidden" id="sensorId" name="sensorId" value="${sensorId}">
<input type="hidden" id="token" name="token" value="${token}">
<input type="hidden" id="saveId" name="saveId" value="${saveId}">
<c:choose>
  <c:when test="${sensorList eq null}"></c:when>
  <c:otherwise>
    <c:forEach var="item" items="${sensorList}">

      <c:choose>
        <c:when test="${empty sensorId }">
          <input type="hidden" id="sensorUuid${item.sensor_uuid}" name="sensorUuid${item.sensor_uuid}" value="${item.sensor_uuid}" />
        </c:when>
        <c:otherwise>
          <input type="hidden" id="sensorUuid${item.sensor_uuid}" name="sensorUuid${item.sensor_uuid}" value="${item.sensor_uuid}" />
        </c:otherwise>
      </c:choose>
      <input type="hidden" id="sensorType" name="sensorType" value="${item.sensor_type}" />
      <input type="hidden" id="topicStr${item.sensor_uuid}" name="topicStr${item.sensor_uuid}" value="${item.topicStr}" />
      <input type="hidden" id="sensorList" name="sensorList" value="${sensorList}" />
      <input type="hidden" id="sensorArr" name="sensorArr" value="${sensorArr}" />
    </c:forEach>
  </c:otherwise>
</c:choose>

<div class="navbar navbar-inverse navbar-bg" role="navigation">
  <div class="navbar-header">
    <div class="logo navbar-bg"><h1><a href="javascript:goMain();"><img src="/images/hntbi.png" width="70" height="32" alt="H&T Logo"></a></h1></div>
    <button type="button" class="navbar-toggle btn-toggle-bg" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
</div>
<div class="template-page-wrapper">
  <div class="navbar-collapse collapse templatemo-sidebar">
    <ul class="templatemo-sidebar-menu">
      <li class="active"><a href="#"><i class="fa fa-home"></i>Dashboard</a></li>
      <li class="sub open">
          <ul class="sidebar-bg" style="height: 40px; padding-top: 10px">
            <strong>${userNm}님 안녕하세요.</strong>
          </ul>
        <c:if test="${userGrade eq 'A' || userGrade eq 'U'}">
          <a href="javascript:;">
            <i class="fa fa-database"></i> 관리 메뉴보기 <div class="pull-right"><span class="caret"></span></div>
          </a>
          <ul class="templatemo-submenu">
            <li><a href="javascript:goUserList();">사용자 관리</a></li>
          </ul>
          <ul class="templatemo-submenu">
            <li><a href="javascript:goCreateSub();">부계정 생성</a></li>
          </ul>
        </c:if>
      </li>
      <li><a href="" data-toggle="modal" data-target="#confirmModal"><i class="fa fa-sign-out"></i>로그아웃</a></li>
    </ul>
  </div><!--/.navbar-collapse -->

  <div class="templatemo-content-wrapper content-bg">
    <div class="templatemo-content content-bg">
      <h1><span class="text-light">Main</span></h1>
      
      <div class="templatemo-charts">
        <div class="row">
          <!--여기부터-->

          
          <c:choose>
            <c:when test="${sensorList eq null}">
              <div class="col-md-12">
                <div class="alert alert-warning">
                  <strong>경고!</strong> sensorList가 null입니다.
                </div>
              </div>
            </c:when>
            <c:when test="${fn:length(sensorList) eq 0}">
              <div class="col-md-12">
                <div class="alert alert-warning">
                  <strong>경고!</strong> sensorList가 비어있습니다. (크기: 0)
                </div>
              </div>
            </c:when>
            <c:otherwise>
              <c:forEach var="item" items="${sensorList}">
              <div class="col-md-6 col-sm-6">
                <span class="btn btn-primary">
                  <c:if test="${userGrade ne 'B'}">
                    <a href="javascript:goSensorSetting_${item.sensor_uuid}();" class="icon-btn" title="장치설정"><i class="bi bi-gear-fill"></i></a>
                  </c:if>
                  <c:if test="${item.chart_type eq 'none'}">
                    <c:if test="${userGrade ne 'B'}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</c:if>
                    <a href="javascript:goChartSetting_${item.sensor_uuid}();" class="icon-btn" title="차트설정"><i class="bi bi-graph-up"></i></a>
                  </c:if>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:goChartData_${item.sensor_uuid}();" class="icon-btn" title="차트데이터"><i class="bi bi-bar-chart-fill"></i></a>
                </span>
                <div class="panel panel-primary">
                  <div class="panel-heading"><strong>${item.sensor_name} <span id="deviceType${item.sensor_uuid}" style="font-size: 12px; color: #ccc;">(장치종류)</span></strong></div>
                  <input type="hidden" id="name${item.sensor_uuid}" name="name${item.sensor_uuid}" value="${item.sensor_name}">
                  <input type="hidden" id="sensorUuid${item.sensor_uuid}" name="sensorUuid${item.sensor_uuid}" value="${item.sensor_uuid}">
                  <input type="hidden" id="topicStr${item.sensor_uuid}" name="topicStr${item.sensor_uuid}" value="${item.topicStr}">
                  <div class="panel-body">
                    <table class="table table-striped">
                      <thead>
                      <tr>
                        <td align="center" width="30%" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; ">구분</span></strong></td>
                        <td align="center" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; ">온도</span></strong></td>
                      </tr>
                      </thead>
                      <tbody>
                      <tr>
                        <td align="center">설정온도</td>
                        <td align="center">
                          <strong><span align="center" id="setTmp${item.sensor_uuid}" name="setTmp${item.sensor_uuid}" style="color: #4cae4c"></span></strong>
                        </td>
                      </tr>
                      <tr>
                        <td align="center" valign="middle">현재온도</td>
                        <td align="center">
                          <strong><span align="center" id="sensorVal${item.sensor_uuid}" name="sensorVal${item.sensor_uuid}" style="color: #c7254e"></span></strong>
                        </td>
                      </tr>
                      </tbody>
                    </table>
                    <table class="table table-striped">
                      <thead>
                      <tr>
                        <td align="center"><div id="status${item.sensor_uuid}" class="status-indicator green"><i class="bi bi-play-circle-fill"></i></div></td>
                        <td align="center"><div id="comp${item.sensor_uuid}" class="status-indicator gray"><i class="bi bi-gear-fill"></i></div></td>
                        <td align="center"><div id="defr${item.sensor_uuid}" class="status-indicator gray"><i class="bi bi-snow"></i></div></td>

                        <td align="center"><div id="fan${item.sensor_uuid}" class="status-indicator gray"><i class="bi bi-fan"></i></div></td>
                        <td align="center"><div id="error${item.sensor_uuid}" class="status-indicator gray"><i class="bi bi-exclamation-triangle-fill"></i></div></td>
                      </tr>
                      </thead>
                      <tbody>
                      <tr>
                                   <td width="20%" align="center" valign="middle" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; font-size:10pt;">운전</span></strong></td>
           <td width="20%" align="center" valign="middle" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; font-size:10pt;">콤프</span></strong></td>
           <td width="20%" align="center" valign="middle" style="background-color: #c7254e;"><strong><span id="defrostLabel${item.sensor_uuid}" style="color: #f0f8ff; font-size:10pt;">제상</span></strong></td>
              
           <td width="20%" align="center" valign="middle" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; font-size:10pt;">FAN</span></strong></td>
           <td width="20%" align="center" valign="middle" style="background-color: #c7254e;"><strong><span style="color: #f0f8ff; font-size:10pt;">이상</span></strong></td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
                  <c:choose>
                    <c:when test="${item.chart_type eq 'none'}">
                    </c:when>
                    <c:otherwise>
                      <div class="col-md-6 col-sm-6">
                        <span class="btn btn-primary">
                          <c:if test="${userGrade ne 'B'}">
                            <a href="javascript:goChartSetting_${item.sensor_uuid}();" class="icon-btn" title="차트설정"><i class="bi bi-graph-up"></i></a>
                          </c:if>
                        </span>
                        <div class="panel panel-primary">
                          <div class="panel-heading">그래프</div>
                          <canvas id="sensorChart${item.sensor_uuid}" height=300" style="height:100%; width:100%"></canvas>
                        </div>
                      </div>
                    </c:otherwise>
                  </c:choose>
              </c:forEach>
            </c:otherwise>
          </c:choose>
          <!--여기까지-->
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title" id="myModalLabel">로그아웃 하시겠습니까?</h4>
        </div>
        <div class="modal-footer">
          <a href="javascript:logoutToLogin();" class="btn btn-primary">Yes</a>
          <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>
  <footer class="templatemo-footer">
    <div class="templatemo-copyright">
      <p>Copyright &copy; 2022 H&T Solutions</p>
    </div>
  </footer>
</div>

<!--script src="/js/jquery.min.js"></script-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/templatemo_script.js"></script>

<!--mqtt js-->
<script src="/js/mqttws31-min.js"></script>
<script src="/js/mqtt_lib.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@1.9.0"></script>
<script src="/js/app-session.js"></script>
<script>
  startConnect();
  // 초기 동기화 디바운스: 로드+연결 후, 또는 복귀 시에도 안전하게 1회만 트리거
  var __pageReady = false;
  var __lastSyncScheduledAt = 0;
  function isMqttConnectedSafe() {
    try {
      return (typeof client !== 'undefined' && client && typeof client.isConnected === 'function' && client.isConnected());
    } catch(e) { return false; }
  }
  function requestInitialSyncOnce(reason) {
    if (!__pageReady) return;
    // MQTT 미연결이어도 서버측 /admin/setSensor가 발행/응답을 처리하므로 초기 동기화는 진행
    var now = Date.now();
    if (now - __lastSyncScheduledAt < 2000) {
      return; // 2초 내 중복 스케줄 방지
    }
    __lastSyncScheduledAt = now;
    setTimeout(function(){
      applyToAllUuids(function(uuid){
        if (typeof window['setSensor_' + uuid] === 'function') {
          window['setSensor_' + uuid]();
        }
      });
    }, 500);
    setTimeout(function(){
      applyToAllUuids(function(uuid){
        if (typeof window['getStatus_' + uuid] === 'function') {
          window['getStatus_' + uuid]();
        }
      });
    }, 2500);
  }
  window.addEventListener('load', function(){ __pageReady = true; });
  // MQTT 연결 성공 시(set by mqtt_lib.js)
  window.addEventListener('mqtt:connected', function(){ requestInitialSyncOnce('mqtt'); });

  // 페이지/연결 안정화 대기 후 동기화 (앱 복귀용)
  function waitForReadyThenSync(maxWaitMs) {
    var start = Date.now();
    (function poll(){
      var pageReady = (document.readyState === 'complete');
      var mqttReady = isMqttConnectedSafe();
      if (pageReady && mqttReady) {
        requestInitialSyncOnce('waitForReadyThenSync');
        return;
      }
      if (Date.now() - start > (maxWaitMs || 6000)) {
        // 타임아웃: MQTT 미연결이어도 초기 동기화 강제 수행 (서버가 처리)
        requestInitialSyncOnce('wait-timeout');
        return;
      }
      setTimeout(poll, 200);
    })();
  }
  // 아이들(가시성 숨김) 시 에러 체크 일시 정지 / 복귀 시 재개 및 초기 동기화
  document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // 백그라운드 진입 즉시: 활성 플래그 내림, 모든 에러체크 타이머/카운터 일시 정지
        if (typeof isPageActive !== 'undefined') { isPageActive = false; }
      if (window.__errorTimers && window.__errorTimers.length) {
        window.__errorTimers.forEach(function(t){ clearInterval(t); });
        window.__errorTimers = [];
      }
        // 배경 진입 시점 기록
        try { window.backgroundStartTime = Date.now(); } catch(e) {}
        // 모든 장치에 에러 체크 유예 부여(앱은 여유 증가)
        var saveY = ($('#saveId').val() || 'N') === 'Y';
        var graceMsBg = saveY ? 40000 : 15000; // 앱은 더 길게 유예
        applyToAllUuids(function(uuid){ pauseError(uuid, graceMsBg); });
    } else {
      if (typeof checkTimeoutAndRedirect === 'function') {
        checkTimeoutAndRedirect();
      }
      // 복귀: 최근 수신 기준 초기화 후 에러 체크 재개
      if (typeof deviceLastDataTime !== 'undefined') {
        deviceLastDataTime = Date.now();
      }
        if (!window.__errorTimers) window.__errorTimers = [];
        // 복귀 즉시: 에러 카운터/상태 리셋 + MQTT 재연결
        // saveId=Y && 백그라운드 30초 초과 시: 첫 ain 수신까지 에러체크 완전 중지(최대 60초 타임아웃)
        var bgDur = 0; try { bgDur = Date.now() - (window.backgroundStartTime || 0); } catch(e) { bgDur = 0; }
        var isApp = ($('#saveId').val() || 'N') === 'Y';
        if (isApp && bgDur > 30000) {
          applyToAllUuids(function(uuid){ pauseError(uuid, 60000); }); // ain 수신 시 즉시 해제, 최대 60초
        } else {
          applyToAllUuids(function(uuid){ pauseError(uuid, 15000); });
        }
        if (typeof startConnect === 'function') { startConnect(); }
        // 복귀 직후 페이지/연결 안정화 대기 후 동기화
        waitForReadyThenSync(6000);
      // 메인은 각 장치별 chkError_uuuu가 있으므로 5초 주기로 재개 (존재 시)
      if (typeof startInterval === 'function' && typeof chkError_${item.sensor_uuid} === 'function') {
        window.__errorTimers.push(startInterval(5, chkError_${item.sensor_uuid}));
      }
      // 2초/4초 1회 초기 동기화는 센서설정/차트에 한정, 메인은 생략
    }
  });

    // 페이지 숨김 이벤트 보강: pagehide/blur에서도 즉시 비활성 처리
    window.addEventListener('pagehide', function(){
      if (typeof isPageActive !== 'undefined') { isPageActive = false; }
      if (window.__errorTimers && window.__errorTimers.length) { window.__errorTimers.forEach(function(t){ clearInterval(t); }); window.__errorTimers = []; }
      applyToAllUuids(function(uuid){ pauseError(uuid, 15000); });
    });
    window.addEventListener('blur', function(){
      if (typeof isPageActive !== 'undefined') { isPageActive = false; }
      if (window.__errorTimers && window.__errorTimers.length) { window.__errorTimers.forEach(function(t){ clearInterval(t); }); window.__errorTimers = []; }
      applyToAllUuids(function(uuid){ pauseError(uuid, 15000); });
    });

    // 장치별 에러 체크 일시정지 관리
    var errorPauseUntil = {};
    var resumeGate = {}; // 복귀 후 첫 ain 수신 전까지 에러 무시
    function pauseError(uuid, ms) {
      try {
        errorPauseUntil[uuid] = Date.now() + (ms || 15000);
        // 카운터/상태 리셋
        window['deviceErrorCounters_' + uuid] = 0;
        window['deviceErrorStates_' + uuid] = false;
        resumeGate[uuid] = true; // 복귀 게이트 활성화
      } catch(e) {}
    }
    function applyToAllUuids(callback) {
      try {
        // 간단한 방법: DOM에서 sensorUuid input 찾기
        $('input[id^="sensorUuid"]').each(function(){
          var uuid = $(this).val();
          if (uuid) { 
            callback(uuid); 
          }
        });
      } catch(e) {
        console.error('applyToAllUuids 오류:', e);
      }
    }
</script>
<c:choose>
  <c:when test="${sensorList eq null}"></c:when>
  <c:otherwise>
    <c:forEach var="item" items="${sensorList}">
    <script type="text/javascript">
      var chartColors_${item.sensor_uuid} = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
      };

      var titleStr_${item.sensor_uuid} = "";
      var xval_${item.sensor_uuid} = 0;
      var yval_${item.sensor_uuid} = 0;
      var setp01_${item.sensor_uuid} = 0;
      var outputVal_${item.sensor_uuid} = "";
      var name_${item.sensor_uuid} = "";

      // MQTT 실시간 데이터만 사용하므로 getData AJAX 함수 제거됨

      function chkError_${item.sensor_uuid}() {
        // 비활성/재연결 유예 중이면 에러 체크 중단
        try {
          if (typeof isPageActive !== 'undefined' && isPageActive === false) return;
          if (typeof client !== 'undefined' && client && typeof client.isConnected === 'function' && !client.isConnected()) return;
          if (errorPauseUntil && errorPauseUntil['${item.sensor_uuid}'] && Date.now() < errorPauseUntil['${item.sensor_uuid}']) return;
          if (resumeGate && resumeGate['${item.sensor_uuid}'] === true) return; // 첫 ain 수신 전까지 무시
          if (typeof navigator !== 'undefined' && navigator && navigator.onLine === false) return; // 오프라인 시 무시
        } catch(e) {}
        var sendData = {
          userId: $('#userId').val(),
          sensorId: $('#sensorId').val(),
          sensorUuid: '${item.sensor_uuid}',
          userToken: $('#token').val()
        }

        //console.log('${item.sensor_uuid}' + " : " + sendData);

        $.ajax({
          url: '/admin/chkError',
          async: true,
          type: 'POST',
          data: JSON.stringify(sendData),
          dataType: 'json',
          contentType: 'application/json',
          success: function (result) {
            console.log("chkerror : " + result.resultCode + "/" + result.resultMessage);
            if (result.resultCode == "200") {
              if(result.resultMessage == "Error") {
                // 1분 이내 인입된 데이터가 0인 경우 통신 오류로 판단하여 알람 발송
                // 깜빡임 방지를 위해 현재 상태와 다른 경우에만 변경
                if($('#status${item.sensor_uuid} img').attr('src') !== '/images/gray.png') {
                  $('#status${item.sensor_uuid}').html('<img src="/images/gray.png" width="25" height="25">');
                }
                $('#sensorVal${item.sensor_uuid}').html('<font size="50px">Error</font>');
                sendNoti("0", "error", '${item.sensor_uuid}', "0");

                // 통신 에러 발생 시 이전까지의 표시는 모두 원복 처리 (깜빡임 방지)
                if($('#error${item.sensor_uuid} img').attr('src') !== '/images/red.png') {
                  $('#error${item.sensor_uuid}').html('<img src="/images/red.png" width="25" height="25">');
                }
                if($('#comp${item.sensor_uuid} img').attr('src') !== '/images/gray.png') {
                  $('#comp${item.sensor_uuid}').html('<img src="/images/gray.png" width="25" height="25">');
                }
                if($('#defr${item.sensor_uuid} img').attr('src') !== '/images/gray.png') {
                  $('#defr${item.sensor_uuid}').html('<img src="/images/gray.png" width="25" height="25">');
                }
                if($('#fan${item.sensor_uuid} img').attr('src') !== '/images/gray.png') {
                  $('#fan${item.sensor_uuid}').html('<img src="/images/gray.png" width="25" height="25">');
                }

              } else {
                //console.log("chkerrror : ok");
                // 깜빡임 방지를 위해 현재 상태와 다른 경우에만 변경
                if($('#status${item.sensor_uuid} img').attr('src') !== '/images/green.png') {
                  $('#status${item.sensor_uuid}').html('<img src="/images/green.png" width="25" height="25">');
                }
                if($('#error${item.sensor_uuid} img').attr('src') !== '/images/gray.png') {
                  $('#error${item.sensor_uuid}').html('<img src="/images/gray.png" width="25" height="25">');
                }
                sendNoti("0", "error_release", '${item.sensor_uuid}', "0");
              }
            }
          },
          error: function (result) {

          }
        });
      }

      function setSensor_${item.sensor_uuid}() {
        // 토픽 유효성 검사: 와일드카드(+,#) 포함 시 호출 보류 후 재시도
        var currentTopic_${item.sensor_uuid} = $('#topicStr${item.sensor_uuid}').val();
        if (!currentTopic_${item.sensor_uuid} || currentTopic_${item.sensor_uuid}.indexOf('+') >= 0 || currentTopic_${item.sensor_uuid}.indexOf('#') >= 0) {
          window['topicRetry_${item.sensor_uuid}'] = (window['topicRetry_${item.sensor_uuid}'] || 0) + 1;
          if (window['topicRetry_${item.sensor_uuid}'] <= 5) {
            setTimeout(function(){ setSensor_${item.sensor_uuid}(); }, 1000);
          } else {
            console.warn('setSensor - 잘못된 topicStr 감지, 재시도 중단:', currentTopic_${item.sensor_uuid});
          }
          return;
        }

        var sendData2 = {
          userId: $('#userId').val(),
          topicStr: currentTopic_${item.sensor_uuid},
          setGu: "readparam",
          type: "1"  // type=1: parameter 요청
        }

        $.ajax({
          url: '/admin/setSensor',
          async: true,
          type: 'POST',
          data: JSON.stringify(sendData2),
          dataType: 'json',
          contentType: 'application/json',
          success: function (result) {
            if (result.resultCode == "200") {

              if(result.resultMsg) {
                if(IsJsonString(result.resultMsg)) {
                  var jsonObj = JSON.parse(result.resultMsg);
                  var rcvTopic = result.rcvTopic;
                  ////console.log(rcvTopic);
                  var rcvTopicArr = Array();

                  if(rcvTopic) {
                    rcvTopicArr = rcvTopic.split("/");
                    if(rcvTopicArr[3] == '${item.sensor_uuid}') {
                      setp01_${item.sensor_uuid} = jsonObj.p01;
                    }
                  }
                }
              }

            }
          },
          error: function (reuslt) {

          }
        });
      }

      function getStatus_${item.sensor_uuid}() {
        // 토픽 유효성 검사: 와일드카드(+,#) 포함 시 호출 보류 후 재시도
        var currentTopic_${item.sensor_uuid} = $('#topicStr${item.sensor_uuid}').val();
        if (!currentTopic_${item.sensor_uuid} || currentTopic_${item.sensor_uuid}.indexOf('+') >= 0 || currentTopic_${item.sensor_uuid}.indexOf('#') >= 0) {
          window['topicRetry_${item.sensor_uuid}'] = (window['topicRetry_${item.sensor_uuid}'] || 0) + 1;
          if (window['topicRetry_${item.sensor_uuid}'] <= 5) {
            setTimeout(function(){ getStatus_${item.sensor_uuid}(); }, 1000);
          } else {
            console.warn('getStatus - 잘못된 topicStr 감지, 재시도 중단:', currentTopic_${item.sensor_uuid});
          }
          return;
        }

        var sendData2 = {
          userId: $('#userId').val(),
          topicStr: currentTopic_${item.sensor_uuid},
          setGu: "readstatus",
          type: "2"  // type=2: status 요청
        }

        $.ajax({
          url: '/admin/setSensor',
          async: true,
          type: 'POST',
          data: JSON.stringify(sendData2),
          dataType: 'json',
          contentType: 'application/json',
          success: function (result) {
            if (result.resultCode == "200") {
            }
          },
          error: function (result) {

          }
        });
      }

      function onRefresh_${item.sensor_uuid}(chart) {
        var now = Date.now();
        var currentValue = 0;

        // MQTT에서 받은 현재 온도 값 사용
        if (typeof yval_${item.sensor_uuid} !== 'undefined' && yval_${item.sensor_uuid} !== null) {
          // Error 상태가 아닐 때만 그래프에 데이터 추가
          if (yval_${item.sensor_uuid} !== 'Error' && yval_${item.sensor_uuid} !== 'error') {
            currentValue = parseFloat(yval_${item.sensor_uuid});
            
            chart.data.datasets.forEach(function(dataset) {
              dataset.data.push({
                x: now,
                y: currentValue
              });
              
              // 데이터 포인트가 너무 많아지면 오래된 데이터 제거 (최대 50개 유지)
              if (dataset.data.length > 50) {
                dataset.data.shift();
              }
            });
          } else {
            // Error 상태일 때는 그래프에 데이터 추가하지 않음
            console.log("그래프 업데이트 스킵 - 장치: ${item.sensor_uuid}, 상태: Error");
          }
        }
      }

      function setSensorId_${item.sensor_uuid}(str) {
        if(str !== "") {
          $('#sensorUuid${item.sensor_uuid}').val(str);
          location.href = "/main/main?sensorId=" + str;
        }
      }

      function goSensorSetting_${item.sensor_uuid}() {
        var sensorUuid = $('#sensorUuid${item.sensor_uuid}').val();
        //startDisconnect();

        // URL 파라미터 없이 장치설정 페이지로 이동
        location.href = "/admin/sensorSetting?sensorUuid="+sensorUuid;
      }

      function goChartSetting_${item.sensor_uuid}() {
        var sensorUuid = $('#sensorUuid${item.sensor_uuid}').val();
        //startDisconnect();

        // URL 파라미터 없이 차트설정 페이지로 이동 (세션 사용)
        location.href = "/admin/chartSetting?sensorUuid="+sensorUuid;
      }

      function goChartData_${item.sensor_uuid}() {
        var sensorUuid = $('#sensorUuid${item.sensor_uuid}').val();
        //startDisconnect();

        // URL 파라미터 최소화 (세션 사용)
        location.href = "/data/chart?sensorUuid="+sensorUuid;
      }

      var chart_type;
      chart_type = '${item.chart_type}';

      if(chart_type != "none") {
        var color_${item.sensor_uuid} = Chart.helpers.color;
        var config_${item.sensor_uuid} = {
          type: '${item.chart_type}',
          data: {
            datasets: [{
              label: titleStr_${item.sensor_uuid},
              backgroundColor: color_${item.sensor_uuid}(chartColors_${item.sensor_uuid}.red).alpha(0.5).rgbString(),
              borderColor: chartColors_${item.sensor_uuid}.red,
              fill: false,
              lineTension: 0,
              pointRadius: 3,
              data: []
            }
            ]
          },
          options: {
            responsive: false,
            title: {
              display: true,
              text: '${item.chart_type} chart'
            },
            scales: {
              xAxes: [{
                type: 'realtime',
                realtime: {
                  duration: 45000,  // 45초로 조정하여 더 촘촘한 간격
                  refresh: 5000,
                  delay: 0,
                  onRefresh: onRefresh_${item.sensor_uuid}
                },
                ticks: {
                  maxTicksLimit: 15,  // 15개의 틱 표시 (더 촘촘한 간격)
                  maxRotation: 45,    // 라벨 회전 각도
                  minRotation: 0
                }
              }],
              yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'value'
                }
              }]
            },
            tooltips: {
              enabled: true,
              mode: 'nearest',
              intersect: false
            },
            hover: {
              mode: 'nearest',
              intersect: false
            }
          }
        };

        var ctx_${item.sensor_uuid} = document.getElementById('sensorChart${item.sensor_uuid}').getContext('2d');
        window.myChart_${item.sensor_uuid} = new Chart(ctx_${item.sensor_uuid}, config_${item.sensor_uuid});

        $('#sensorChart${item.sensor_uuid}').show();
      }

    </script>
    </c:forEach>
  </c:otherwise>
</c:choose>

    <script>
      // 함수 호이스팅을 위한 함수 선언
      function validateJson(str) {
        try {
          var json = JSON.parse(str);
          return (typeof json === 'object');
        } catch (e) {
          return false;
        }
      }

      function IsJsonString(str) {
        try {
          var json = JSON.parse(str);
          return (typeof json === 'object');
        } catch (e) {
          return false;
        }
      }

      function startInterval(seconds, callback, gu) {
        callback();
        return setInterval(callback, seconds * 1000);
      }

      function sendNoti(sensorVal, gu, uuid, type) {
        // saveid 설정 확인
        var currentSaveId = $('#saveId').val() || 'N';
        
        // saveid가 N인 경우 알림 전송하지 않음
        if (currentSaveId !== 'Y') {
          console.log('saveid N 설정: 알림 전송 건너뜀');
          return;
        }
        
        var userId = $('#userId').val();
        var sensorId = $('#sensorId').val();
        var token = $('#token').val();
        var sensorName = $('#name'+uuid).val();

        var sendData2 = {
          userId: userId,
          sensorId: sensorId,
          sensorUuid: uuid,
          sensorValue: sensorVal,
          token: token,
          name: gu,
          type: type
        }

        console.log('saveid Y 설정: 알림 전송 시작 - ' + gu + ' / ' + uuid);

        $.ajax({
          url: '/main/sendAlarm',
          async: true,
          type: 'POST',
          data: JSON.stringify(sendData2),
          dataType: 'json',
          contentType: 'application/json',
          success: function (result) {
            if (result.resultCode == "200") {
              console.log('알림 전송 성공');
            }
          },
          error: function (result) {
            console.log('알림 전송 실패');
          }
        });
      }

      function goMain() {
        var userId = $('#loginUserId').val() || $('#userId').val();
        var userGrade = $('#userGrade').val();
        
        if (!userId || userId === "" || userId === "null") {
          location.href = "/main/main";
          return;
        }
        
        // URL 파라미터 없이 메인 페이지로 이동
        location.href = "/main/main";
      }

      function goUserList() {
        var userId = $('#loginUserId').val() || $('#userId').val();
        var userGrade = $('#userGrade').val();
        
        if (!userId || userId === "" || userId === "null") {
          location.href = "/admin/userList";
          return;
        }
        
        // URL 파라미터 없이 사용자 관리 페이지로 이동
        location.href = "/admin/userList";
      }

      function goCreateSub() {
        var userId = $('#loginUserId').val() || $('#userId').val();
        var userGrade = $('#userGrade').val();
        
        if (!userId || userId === "" || userId === "null") {
          location.href = "/admin/createSub";
          return;
        }
        
        // URL 파라미터 없이 부계정 생성 페이지로 이동
        location.href = "/admin/createSub";
      }

      // 공통 현재온도 처리 함수
      function updateCurrentTemperature(sensorUuid, value, isError) {
        if(isError) {
          $('#sensorVal'+sensorUuid).html('<font size="50px">Error</font>');
        } else {
          $('#sensorVal'+sensorUuid).html('<font size="50px">' + value + '°C</font>');
        }
      }
      
      // 상태표시등 업데이트 함수 (Bootstrap Icons 사용)
      function updateStatusIndicator(elementId, status, type) {
        var iconClass = '';
        var statusClass = '';
        
        // 제상/히터 타입은 장치종류에 따라 아이콘 결정
        if(type === 'defr') {
          // 장치종류 확인 (p16 값)
          var sensorUuid = elementId.replace('defr', '');
          var deviceType = window['deviceType_' + sensorUuid] || '0'; // 기본값은 Cooler
          
          if(deviceType === '1') { // Heater
            iconClass = 'bi-thermometer-half';
          } else { // Cooler
            iconClass = 'bi-snow';
          }
        } else {
          switch(type) {
            case 'status':
              iconClass = status === 'green' ? 'bi-play-circle-fill' : 'bi-pause-circle-fill';
              break;
            case 'comp':
              iconClass = 'bi-gear-fill';
              break;
            case 'fan':
              iconClass = 'bi-fan'; // Bootstrap Icons의 팬 아이콘 사용
              break;
            case 'error':
              iconClass = 'bi-exclamation-triangle-fill';
              break;
          }
        }
        
        statusClass = status === 'green' ? 'green' : (status === 'red' ? 'red' : 'gray');
        
        $('#' + elementId).html('<i class="bi ' + iconClass + '"></i>').removeClass().addClass('status-indicator ' + statusClass);
      }

      // 장치별 에러 체크 함수 (실시간 온도 데이터 기반)
      function chkError(sensor_uuid) {
        // 복귀/백그라운드/연결상태/유예 게이트
        try {
          if (typeof isPageActive !== 'undefined' && isPageActive === false) return;
          if (typeof client !== 'undefined' && client && typeof client.isConnected === 'function' && !client.isConnected()) return;
          if (errorPauseUntil && errorPauseUntil[sensor_uuid] && Date.now() < errorPauseUntil[sensor_uuid]) return;
          if (resumeGate && resumeGate[sensor_uuid] === true) return; // 첫 ain 수신 전까지 무시
          if (typeof navigator !== 'undefined' && navigator && navigator.onLine === false) return;
        } catch(e) {}
        var deviceLastDataTime = window['deviceLastDataTime_' + sensor_uuid] || 0;
        var deviceErrorCounters = window['deviceErrorCounters_' + sensor_uuid] || 0;
        var deviceErrorStates = window['deviceErrorStates_' + sensor_uuid] || false;
        
        var currentTime = Date.now();
        var timeDiff = currentTime - deviceLastDataTime;
        
        // 15초 동안 온도 데이터 미수신 시 에러 체크
        if (timeDiff > 15000 && !deviceErrorStates) {
          deviceErrorCounters++;
          
          // 3번 연속 미수신 시 에러 상태로 변경
          if (deviceErrorCounters >= 3) {
            deviceErrorStates = true;
            
            // 상태표시등 업데이트 (Bootstrap Icons 사용)
            updateStatusIndicator('status'+sensor_uuid, 'gray', 'status');
            $('#sensorVal'+sensor_uuid).html('<font size="50px">Error</font>');
            
            // 에러 상태일 때 그래프에도 Error 표시
            if (typeof window['yval_' + sensor_uuid] !== 'undefined') {
              window['yval_' + sensor_uuid] = 'Error';
            }
            
            sendNoti("0", "error", sensor_uuid, "0");

            // 상태 표시등 업데이트
            updateStatusIndicator('error'+sensor_uuid, 'red', 'error');
            updateStatusIndicator('comp'+sensor_uuid, 'gray', 'comp');
            updateStatusIndicator('defr'+sensor_uuid, 'gray', 'defr');
            updateStatusIndicator('fan'+sensor_uuid, 'gray', 'fan');
            
            // 상태 변수 업데이트
            window['deviceErrorStates_' + sensor_uuid] = true;
            window['deviceErrorCounters_' + sensor_uuid] = deviceErrorCounters;
          } else {
            // 카운터만 업데이트
            window['deviceErrorCounters_' + sensor_uuid] = deviceErrorCounters;
          }
        }
      }

      window.onload = function() {
        // MQTT 연결 시작
        startConnect();
        
        <c:choose>
            <c:when test="${sensorList eq null}"></c:when>
            <c:otherwise>
                <c:forEach var="item" items="${sensorList}">
                    // 장치별 에러 체크 변수 초기화
                    window['deviceLastDataTime_${item.sensor_uuid}'] = Date.now();
                    window['deviceErrorCounters_${item.sensor_uuid}'] = 0;
                    window['deviceErrorStates_${item.sensor_uuid}'] = false;
                    window['deviceStatusStates_${item.sensor_uuid}'] = 'gray';
                    window['deviceErrorDisplayStates_${item.sensor_uuid}'] = 'gray';
                    window['deviceDinErrorStates_${item.sensor_uuid}'] = false;
                    
                    // MQTT 실시간 데이터만 사용하므로 getData AJAX 호출 제거
                    // setTimeout(function() {
                    //   startInterval(0.5, getData_${item.sensor_uuid}, "1");
                    // }, 500);

                    // 장치별 에러 체크 시작 (5초마다)
                    setTimeout(function() {
                      if (!window.__errorTimers) window.__errorTimers = [];
                      var handle = startInterval(5, function() { chkError('${item.sensor_uuid}'); }, "2");
                      window.__errorTimers.push(handle);
                    }, 3000); // 5000ms → 3000ms로 단축

                    // 초기 요청은 mqtt:connected 이벤트 리스너에서 일괄 처리

                    var yval_${item.sensor_uuid} = 0;
                </c:forEach>
            </c:otherwise>
        </c:choose>
      };

      function rcvMsg(topic, message) {
        if(topic) {
          var topicArr = new Array();
          topicArr = topic.split("/");
          let uuid = topicArr[3];
          let userId = topicArr[1];

          // 현재 사용자의 장치만 처리 (부계정 사용자 고려)
          // userId는 토픽의 사용자 ID, sensorId는 실제 장치 소유자
          var currentSensorId = $('#sensorId').val();
          var currentUserId = $('#userId').val();
          
          // 현재 사용자의 장치가 아닌 경우 처리 중단
          if (userId !== currentSensorId && userId !== currentUserId) {
            return;
          }

          ////console.log("topic : " + topic);
          ////console.log("message : " + message);

          if(message) {
            if(validateJson(message)) {
              var msg = JSON.parse(message);
              ////console.log("msg : " + msg);

              if(msg.actcode == 'live') {
                if(userId == $('#sensorId').val() || userId == $('#userId').val()) {
                  // 센서 정보 입력 처리 추가 - 페이지 새로고침 제거
                  var insertData = {
                    userId: $('#userId').val(),
                    uuid: uuid
                  }

                  $.ajax({
                    url: '/main/insertSensorInfo',
                    async: true,
                    type: 'POST',
                    data: JSON.stringify(insertData),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                      if (result.resultCode == "200") {
                        // 페이지 새로고침 제거 - 무한 새로고침 방지
                      }
                    },
                    error: function (reuslt) {
                      // 에러 처리
                    }
                  });
                }

                if(msg.name == 'ain') {
                  // 현재 온도 알림 - 공통 함수 사용
                  var sensorUuid = topicArr[3];
                  // 데이터 수신 시점에 에러 유예 즉시 해제(소폭 유예 유지 가능)
                  try {
                    if (errorPauseUntil && errorPauseUntil[sensorUuid]) { delete errorPauseUntil[sensorUuid]; }
                    if (resumeGate && resumeGate[sensorUuid]) { resumeGate[sensorUuid] = false; }
                  } catch(e) {}
                  var isError = (msg.value == 'Error');
                  
                  // 공통 현재온도 처리 함수 호출
                  updateCurrentTemperature(sensorUuid, msg.value, isError);
                  
                  if(isError) {
                    // 에러 상태일 때 그래프에도 Error 표시
                    if (typeof window['yval_' + sensorUuid] !== 'undefined') {
                      window['yval_' + sensorUuid] = 'Error';
                    }
                    
                    if($('#userId').val() == topicArr[1]) {
                      sendNoti("Error", 'ain', topicArr[3], msg.type);
                    }
                  } else {
                    
                    // MQTT에서 정상 온도 데이터 수신 시 에러 상태 해제
                    var sensorUuid = topicArr[3];
                    var deviceErrorStates = window['deviceErrorStates_' + sensorUuid] || false;
                    
                    if (deviceErrorStates) {
                      deviceErrorStates = false;
                      window['deviceErrorStates_' + sensorUuid] = false;
                      window['deviceErrorCounters_' + sensorUuid] = 0;
                      
                      // 에러 해제 후 GET&type=1, GET&type=2 2초 간격으로 한 번만 요청
                      setTimeout(function() {
            // 토픽 유효성 검사 후 호출
            var t = $('#topicStr' + sensorUuid).val();
            if (t && t.indexOf('+') < 0 && t.indexOf('#') < 0 && typeof window['setSensor_' + sensorUuid] === 'function') {
              window['setSensor_' + sensorUuid]();
                        }
                      }, 2000);
                      
                      setTimeout(function() {
            var t = $('#topicStr' + sensorUuid).val();
            if (t && t.indexOf('+') < 0 && t.indexOf('#') < 0 && typeof window['getStatus_' + sensorUuid] === 'function') {
              window['getStatus_' + sensorUuid]();
                        }
                      }, 4000); // 2초 + 2초 = 4초 후
                    }
                    
                    // 정상 온도 데이터 수신 시 상태 업데이트 (Bootstrap Icons 사용)
                    // DIN 이상이 활성 중이면 이상표시는 유지
                    if (!window['deviceDinErrorStates_' + topicArr[3]]) {
                      updateStatusIndicator('error'+topicArr[3], 'gray', 'error');
                    }
                    updateStatusIndicator('status'+topicArr[3], 'green', 'status');
                    
                    // 마지막 데이터 수신 시간 업데이트
                    window['deviceLastDataTime_' + sensorUuid] = Date.now();
                    
                    // 온도 데이터 수신 시점에 바로 에러 체크
                    chkError(sensorUuid);
                    
                    if($('#userId').val() == topicArr[1]) {
                      // 온도 알람이 사용 설정된 경우에만 알림 전송
                      // 메인 페이지에서는 알람 설정을 DB에서 확인할 수 없으므로
                      // 서버 측에서만 알람 조건을 체크하도록 함
                      // 클라이언트에서는 무조건 sendNoti 호출 (서버에서 알람 설정 확인)
                      sendNoti(msg.value, 'ain', topicArr[3], msg.type);
                    }
                    
                    // 정상 온도 데이터일 때만 그래프 업데이트
                    if (typeof window['yval_' + sensorUuid] !== 'undefined') {
                      window['yval_' + sensorUuid] = parseFloat(msg.value);
                    }
                  }
                } else if(msg.name == 'din') {
                  // digital input 상태 변화 알림
                  if(msg.type == '1' && msg.ch == '1') {
                    if(msg.value == '1') {
                      // din, type 1, ch1, value 1인 경우: 운전으로 표시하지만 이상으로 표시
                      updateStatusIndicator('status'+topicArr[3], 'green', 'status');
                      window['deviceDinErrorStates_' + topicArr[3]] = true;
                      updateStatusIndicator('error'+topicArr[3], 'red', 'error');
                      if($('#userId').val() == topicArr[1]) {
                        sendNoti(msg.value, 'din', topicArr[3], msg.type);
                      }
                    } else {
                      // din, type 1, ch1, value 0인 경우: 이상 해제
                      window['deviceDinErrorStates_' + topicArr[3]] = false;
                      updateStatusIndicator('error'+topicArr[3], 'gray', 'error');
                      if($('#userId').val() == topicArr[1]) {
                        sendNoti(msg.value, 'din', topicArr[3], msg.type);
                      }
                    }
                  }
                } else if(msg.name == 'output') {
                  console.log('=== output 메시지 수신 ===');
                  console.log('UUID:', topicArr[3]);
                  console.log('Type:', msg.type);
                  console.log('Value:', msg.value);
                  console.log('Message:', msg);
                  // output 상태 변화 알림
                  if(msg.value == '1') {
                    if(msg.type == '1') {
                      // comp 이상
                      updateStatusIndicator('comp'+topicArr[3], 'red', 'comp');
                    } else if(msg.type == '2') {
                      // def 이상
                      updateStatusIndicator('defr'+topicArr[3], 'red', 'defr');
                    } else if(msg.type == '3') {
                      // fan 이상
                      updateStatusIndicator('fan'+topicArr[3], 'red', 'fan');
                    }
                  } else if(msg.value == '0') {
                    if(msg.type == '1') {
                      updateStatusIndicator('comp'+topicArr[3], 'gray', 'comp');
                    } else if(msg.type == '2') {
                      updateStatusIndicator('defr'+topicArr[3], 'gray', 'defr');
                    } else if(msg.type == '3') {
                      updateStatusIndicator('fan'+topicArr[3], 'gray', 'fan');
                    }
                  }
                }
              } else if(msg.actcode == "setres") {
                if(msg.p01.length > 0) {
                  if(msg.p01) {
                    if(msg.p01.length == 1) {
                      msg.p01 = "0." + msg.p01;
                    } else if(msg.p01.length == 2) {
                      msg.p01 = msg.p01.substr(0, 1) + "." + msg.p01.substr(1, 2);
                    } else if(msg.p01.length == 3) {
                      msg.p01 = msg.p01.substr(0, 2) + "." + msg.p01.substr(2, 3);
                    } else if(msg.p01.length == 4) {
                      msg.p01 = msg.p01.substr(0, 3) + "." + msg.p01.substr(3, 4);
                    }
                  }
                }
                $('#setTmp'+topicArr[3]).html(msg.p01 + '°C');
                
                // 장치종류 업데이트
                if(msg.p16) {
                  var deviceTypeText = "";
                  if(msg.p16 == "0") {
                    deviceTypeText = "Cooler";
                  } else if(msg.p16 == "1") {
                    deviceTypeText = "Heater";
                  } else {
                    deviceTypeText = "Cooler"; // 기본값
                  }
                  $('#deviceType'+topicArr[3]).text('(' + deviceTypeText + ')');
                  
                  // 장치종류를 전역 변수에 저장 (updateStatusIndicator 함수에서 사용)
                  window['deviceType_' + topicArr[3]] = msg.p16;
                  
                  // 장치종류에 따른 상태표시등 텍스트와 아이콘 변경
                  if(msg.p16 == "1") { // Heater
                    $('#defrostLabel'+topicArr[3]).text("히터");
                    // 히터 아이콘으로 변경 (thermometer-half)
                    $('#defr'+topicArr[3]).html('<i class="bi bi-thermometer-half"></i>').removeClass().addClass('status-indicator gray');
                  } else { // Cooler
                    $('#defrostLabel'+topicArr[3]).text("제상");
                    // 제상 아이콘으로 변경 (snow)
                    $('#defr'+topicArr[3]).html('<i class="bi bi-snow"></i>').removeClass().addClass('status-indicator gray');
                  }
                }
              } else if(msg.actcode == "actres") {

              }
            }
          }
        }
      }

      // JSP EL 값을 JavaScript 변수로 저장
      var currentUserId = '${userId}';
      var currentUserGrade = '${userGrade}';
      
      // 웹뷰 환경 감지 함수
      function isWebView() {
          return (typeof Android !== 'undefined' && Android.finish) || 
                 (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeApp);
      }
      
      // 메인 페이지 뒤로가기 처리 설정
      function setupMainPageBackNavigation() {
                    // 히스토리 관리는 DOM 로드 완료 후 지연 실행 (성능 최적화)
          setTimeout(function() {
              // 로그인 후 첫 진입인지 확인 (더 정확한 로직)
              var isFirstLogin = false;
              
              // 세션 스토리지를 사용하여 첫 진입 여부 확인
              var firstVisit = sessionStorage.getItem('mainPageFirstVisit');
              if (firstVisit === null || firstVisit === 'true') {
                  isFirstLogin = true;
                  sessionStorage.setItem('mainPageFirstVisit', 'false');
              }
              
              console.log('=== 히스토리 관리 디버깅 ===');
              console.log('isFirstLogin:', isFirstLogin);
              console.log('firstVisit:', firstVisit);
              console.log('history.length:', history.length);
              console.log('현재 URL:', window.location.href);
              
              // 히스토리 정리 (history.go() 제거하고 replaceState만 사용)
              if (!isFirstLogin) {
                  console.log('히스토리 정리 실행 - replaceState 사용');
                  // 히스토리를 메인 페이지만 남기고 정리
                  history.replaceState({page: 'main'}, '메인', '/main/main');
                  
                  // 추가로 강제 히스토리 정리 실행
                  setTimeout(function() {
                      forceCleanHistory();
                  }, 50);
              } else {
                  console.log('히스토리 정리 건너뛰기 - 첫 진입');
              }
              console.log('히스토리 상태 설정 완료');
          }, 200); // 200ms 지연으로 페이지 로딩 우선 (시간 증가)
          
          // 뒤로가기 시도 시 처리
          window.addEventListener('popstate', function(event) {
              // 웹뷰 환경 확인 후 처리
              if (isWebView()) {
                  if (typeof Android !== 'undefined' && Android.finish) {
                      // Android 앱 종료
                      Android.finish();
                  } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeApp) {
                      // iOS 앱 종료
                      window.webkit.messageHandlers.closeApp.postMessage('close');
                  }
              } else {
                  // 일반 브라우저에서는 페이지 새로고침으로 실시간 데이터 초기화
                  window.location.reload(true);
              }
          });
          
          // 키보드 뒤로가기 단축키 처리
          document.addEventListener('keydown', function(event) {
              if (event.altKey && event.keyCode === 37) { // Alt + Left Arrow
                  event.preventDefault();
                  event.stopPropagation();
                  
                  if (isWebView()) {
                      if (typeof Android !== 'undefined' && Android.finish) {
                          Android.finish();
                      } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeApp) {
                          window.webkit.messageHandlers.closeApp.postMessage('close');
                      }
                  } else {
                      window.location.reload(true);
                  }
                  return false;
              }
          });
          
          // 마우스 뒤로가기 버튼 처리
          document.addEventListener('mousedown', function(event) {
              if (event.button === 3 || event.button === 4) { // 뒤로가기/앞으로가기 버튼
                  event.preventDefault();
                  event.stopPropagation();
                  
                  if (isWebView()) {
                      if (typeof Android !== 'undefined' && Android.finish) {
                          Android.finish();
                      } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeApp) {
                          window.webkit.messageHandlers.closeApp.postMessage('close');
                      }
                  } else {
                      window.location.reload(true);
                  }
                  return false;
              }
          });
      }
      
      // 메인 페이지 뒤로가기 처리 설정 실행 (모든 리소스 로드 완료 후)
      window.addEventListener('load', function() {
          console.log('=== 페이지 완전 로드 완료 ===');
          setupMainPageBackNavigation();
      });
      
      // 다른 페이지로 이동 시 히스토리 정리 (필요시 사용)
      function navigateToPage(url) {
          // 현재 히스토리 상태를 메인으로 정리
          history.replaceState({page: 'main'}, '메인', '/main/main');
          // 새 페이지로 이동
          window.location.href = url;
      }
      
      // 강력한 히스토리 정리 함수
      function forceCleanHistory() {
          console.log('=== 강제 히스토리 정리 시작 ===');
          console.log('현재 히스토리 길이:', history.length);
          
          // 히스토리를 메인 페이지만 남기고 완전히 정리
          if (history.length > 1) {
              // 모든 히스토리 엔트리를 메인으로 교체
              for (var i = 0; i < history.length; i++) {
                  history.replaceState({page: 'main'}, '메인', '/main/main');
              }
              console.log('히스토리 강제 정리 완료');
          }
      }
      
      // 로그아웃 시 세션 스토리지 정리
      function clearMainPageSession() {
          sessionStorage.removeItem('mainPageFirstVisit');
      }
      
      // 페이지 이탈 시 강제 로그아웃을 수행하지 않습니다.
      // 내부 네비게이션 중 세션이 끊기는 문제를 방지하기 위함입니다.
      
      // 페이지 포커스 감지 (사용자가 다른 탭으로 이동하는 경우)
      var isPageActive = true;
      var lastActivityTime = Date.now();
      var backgroundStartTime = null;
      var currentSaveId = $('#saveId').val() || 'N'; // saveid 설정 확인
      
      console.log('현재 saveid 설정: ' + currentSaveId);
      
      document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
              // 페이지가 숨겨졌을 때 (다른 탭으로 이동)
              isPageActive = false;
              backgroundStartTime = Date.now();
              
              if (currentSaveId === 'Y') {
                  // saveid가 Y인 경우: MQTT 연결 유지
                  console.log('페이지 비활성화됨 - saveid Y 설정으로 MQTT 연결 유지 중');
                  
                  // MQTT 연결 상태 확인 및 유지
                  if (typeof client !== 'undefined' && client.isConnected()) {
                      console.log('백그라운드에서 MQTT 연결 유지 중...');
                  }
              } else {
                  // saveid가 N인 경우: 기존 로직 유지
                  console.log('페이지 비활성화됨 - saveid N 설정으로 기존 로직 적용');
              }
          } else {
              // 페이지가 다시 활성화되었을 때
              isPageActive = true;
              lastActivityTime = Date.now();
              console.log('페이지 활성화됨');
              
              if (currentSaveId === 'Y') {
                  // saveid가 Y인 경우: 즉시 MQTT 연결 상태 확인 및 복구
                  console.log('saveid Y 설정: 페이지 활성화 시 MQTT 연결 상태 확인');
                  
                  // MQTT 연결 상태 즉시 확인
                  if (typeof client !== 'undefined') {
                      if (!client.isConnected()) {
                          console.log('MQTT 연결이 끊어져 있음 - 즉시 재연결 시도');
                          if (typeof startConnect === 'function') {
                              startConnect();
                          }
                      } else {
                          console.log('MQTT 연결 상태 정상 - 실시간 데이터 수신 확인');
                          // 연결은 되어 있지만 데이터가 오지 않는 경우를 대비해 재연결 시도
                          setTimeout(function() {
                              if (typeof startConnect === 'function') {
                                  console.log('MQTT 연결 상태 재확인 및 필요시 재연결');
                                  startConnect();
                              }
                          }, 2000); // 2초 후 재확인
                      }
                  } else {
                      console.log('MQTT 클라이언트가 정의되지 않음 - 연결 시도');
                      if (typeof startConnect === 'function') {
                          startConnect();
                      }
                  }
                  
                  // 백그라운드 시간이 30분 이상이었으면 추가 재연결 시도
                  if (backgroundStartTime && (Date.now() - backgroundStartTime) > 1800000) { // 30분
                      console.log('30분 이상 백그라운드 상태였으므로 추가 MQTT 재연결 시도');
                      setTimeout(function() {
                          if (typeof startConnect === 'function') {
                              startConnect();
                          }
                      }, 5000); // 5초 후 추가 재연결
                  }
              }
              
              backgroundStartTime = null;
          }
      });
      
      // 앱 포커스 관련 커스텀 로직 제거 (기본 동작만 유지)
      
      // 앱 인터페이스 함수 (앱에서 호출)
      window.appResume = function() {
          console.log('앱에서 resume 이벤트 호출됨');
          if (currentSaveId === 'Y') {
              console.log('saveid Y 설정: 앱 resume 시 MQTT 연결 복구');
              
              // 즉시 MQTT 연결 상태 확인 및 복구
              setTimeout(function() {
                  if (typeof client !== 'undefined') {
                      if (!client.isConnected()) {
                          console.log('앱 resume 시 MQTT 연결 끊어짐 - 즉시 재연결');
                          if (typeof startConnect === 'function') {
                              startConnect();
                          }
                      } else {
                          console.log('앱 resume 시 MQTT 연결 상태 정상');
                      }
                  } else {
                      console.log('앱 resume 시 MQTT 클라이언트 미정의 - 연결 시도');
                      if (typeof startConnect === 'function') {
                          startConnect();
                      }
                  }
              }, 500); // 0.5초 후 확인
          }
      };
      
      // 주기적으로 페이지 활성 상태 확인 (saveid 설정에 따라 다르게 처리)
      setInterval(function() {
          if (!isPageActive) {
              var backgroundDuration = Date.now() - (backgroundStartTime || Date.now());
              
              if (currentSaveId === 'Y') {
                  // saveid가 Y인 경우: 30분 이상 비활성 상태일 때만 로그아웃 처리
                  if (backgroundDuration > 1800000) { // 30분
                      console.log('saveid Y 설정: 60분 이상 비활성 상태로 인한 로그아웃 처리');
                      performLogout();
                  }
              } else {
                  // saveid가 N인 경우: 기존 로직 (5분)
                  if (backgroundDuration > 300000) { // 5분
                      console.log('saveid N 설정: 5분 이상 비활성 상태로 인한 로그아웃 처리');
                      performLogout();
                  }
              }
          }
      }, currentSaveId === 'Y' ? 1800000 : 300000); // saveid Y: 30분, saveid N: 5분
      
      // 로그아웃 처리 함수
      function performLogout() {
          console.log('=== 로그아웃 처리 시작 ===');
          console.log('로그아웃 시간: ' + new Date().toLocaleString());
          
          // MQTT 연결 종료 (로그아웃 시에만)
          if (typeof logoutMqttDisconnect === 'function') {
              console.log('MQTT 연결 종료 함수 호출');
              logoutMqttDisconnect();
          } else {
              console.log('MQTT 연결 종료 함수가 정의되지 않음');
          }
          
          var xhr = new XMLHttpRequest();
          xhr.open('POST', '/login/logoutProcess', false);
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          var logoutData = {
              userId: currentUserId
          };
          
          try {
              xhr.send(JSON.stringify(logoutData));
              console.log('페이지 비활성 상태로 인한 로그아웃 처리 완료');
              // 앱/브라우저 공통: 로그인 페이지로 이동
              window.location.href = '/login/login';
          } catch(e) {
              console.log('비활성 상태 로그아웃 처리 실패:', e);
          }
      }

      // 사용자 클릭 로그아웃(모달 Yes) 시: 항상 로그인 페이지로 이동
      function logoutToLogin() {
        var currentUserId = $('#loginUserId').val() || $('#userId').val() || '';
        $.ajax({
          url: '/login/logoutProcess',
          type: 'POST',
          async: false,
          data: JSON.stringify({ userId: currentUserId }),
          contentType: 'application/json',
          complete: function() {
            window.location.href = '/login/login';
          }
        });
      }
      
      // MQTT 초기 동기화 강제 실행 함수
      function forceInitialSync() {
        console.log('=== MQTT 초기 동기화 강제 실행 ===');
        
        // 모든 장치에 대해 초기 동기화 실행
        applyToAllUuids(function(uuid) {
          console.log('장치 ' + uuid + ' 초기 동기화 시작');
          
          // 1. 설정값 요청 (GET&type=1)
          if (typeof window['setSensor_' + uuid] === 'function') {
            console.log('setSensor_' + uuid + ' 함수 호출');
            window['setSensor_' + uuid]();
          } else {
            console.warn('setSensor_' + uuid + ' 함수가 정의되지 않음');
          }
          
          // 2. 상태정보 요청 (GET&type=2) - 2초 후 실행
          setTimeout(function() {
            if (typeof window['getStatus_' + uuid] === 'function') {
              console.log('getStatus_' + uuid + ' 함수 호출');
              window['getStatus_' + uuid]();
            } else {
              console.warn('getStatus_' + uuid + ' 함수가 정의되지 않음');
            }
          }, 2000);
        });
        
        console.log('MQTT 초기 동기화 강제 실행 완료');
      }
      
      // MQTT 상태 확인 함수
      function checkMqttStatus() {
        console.log('=== MQTT 상태 확인 ===');
        
        // MQTT 클라이언트 상태 확인
        if (typeof client !== 'undefined') {
          console.log('MQTT 클라이언트 상태:', client.isConnected() ? '연결됨' : '연결 안됨');
          console.log('MQTT 클라이언트 ID:', client.clientId);
        } else {
          console.log('MQTT 클라이언트가 정의되지 않음');
        }
        
        // 토픽 정보 확인
        applyToAllUuids(function(uuid) {
          var topicStr = $('#topicStr' + uuid).val();
          console.log('장치 ' + uuid + ' 토픽:', topicStr);
        });
        
        // 세션 정보 확인
        console.log('현재 사용자 ID:', $('#userId').val());
        console.log('현재 센서 ID:', $('#sensorId').val());
      }
    </script>
  </body>
</html>