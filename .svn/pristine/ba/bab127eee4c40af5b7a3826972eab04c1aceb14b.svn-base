package com.andrew.hnt.api.controller;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.andrew.hnt.api.model.DeviceVO;
import com.andrew.hnt.api.model.ExcelTest;
import com.andrew.hnt.api.model.UserInfo;
import com.andrew.hnt.api.mqtt.common.MQTT;
import com.andrew.hnt.api.service.AdminService;
import com.andrew.hnt.api.util.ExcelUtils;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import com.andrew.hnt.api.model.LoginVO;
import com.andrew.hnt.api.service.DataService;
import com.andrew.hnt.api.service.LoginService;

@Controller
@RequestMapping("/data")
public class DataController extends DefaultController {
	
	@Autowired
	private DataService dataService;

	@Autowired
	private AdminService adminService;

	@Autowired
	private CommonController commonController;

	@Autowired
	private LoginService loginService;

	private Logger logger = LoggerFactory.getLogger(this.getClass());

	@RequestMapping(value = "/getSensorList", method = RequestMethod.POST)
	public @ResponseBody Map<String, Object> getSensorList(
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestBody LoginVO loginVO
			) {
		Map<String, Object> resultMap = new HashMap<String, Object>();
		List<Map<String, Object>> deviceList = new ArrayList<Map<String, Object>>();
		
		try {
			if(null != loginVO) {
				String userId = loginVO.getUserId();

				deviceList = dataService.getDeviceList(userId);
				
				if(null != deviceList && 0 < deviceList.size()) {
					resultMap.put("deviceList", deviceList);
				} else {
					deviceList = null;
					resultMap.put("deviceList", deviceList);
				}
				
				resultMap.put("resultCode", "200");
				resultMap.put("resultMessage", "ì¥ì¹˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ");
			}
		} catch(Exception e) {
			logger.error("Error : ì¥ì¹˜ ëª©ë¡ ì¡°íšŒ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ë°œìƒ");
			e.printStackTrace();
			resultMap.put("resultCode", "999");
			resultMap.put("resultMessage", "ì¥ì¹˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");
		}
		
		return resultMap;
	}

	@RequestMapping(value = "/updateSensorInfo", method = RequestMethod.POST)
	public @ResponseBody Map<String, Object> updateSensorInfo(
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestBody DeviceVO deviceVO
			, @RequestParam(name = "userId", required = false) String userId
			, @RequestParam(name = "userGrade", required = false) String userGrade
			, @RequestParam(name = "userNm", required = false) String userNm
			) {
		Map<String, Object> resultMap = new HashMap<String, Object>();

		if(null != deviceVO) {
			try {
				// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
				HttpSession session = req.getSession();
				String sessionUserId = (String) session.getAttribute("userId");
				String sessionUserGrade = (String) session.getAttribute("userGrade");
				String sessionUserNm = (String) session.getAttribute("userNm");
				
				logger.info("=== ì„¸ì…˜ ì •ë³´ í™•ì¸ ===");
				logger.info("ì„¸ì…˜ userId: {}, userGrade: {}, userNm: {}", sessionUserId, sessionUserGrade, sessionUserNm);
				logger.info("URL íŒŒë¼ë¯¸í„° userId: {}, userGrade: {}, userNm: {}", userId, userGrade, userNm);
				logger.info("DeviceVO userId: {}, sensorUuid: {}, sensorName: {}", 
					deviceVO.getUserId(), deviceVO.getSensorUuid(), deviceVO.getSensorName());
				
				// 1ìˆœìœ„: URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ (MainControllerì™€ ë™ì¼í•œ ë°©ì‹)
				if (userId != null && !userId.isEmpty() && userGrade != null && !userGrade.isEmpty()) {
					logger.info("URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ì— ì¦‰ì‹œ ì„¤ì • - userId: {}, userGrade: {}, userNm: {}", 
							   userId, userGrade, userNm);
					
					// ì•±ì—ì„œ ì „ë‹¬ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ì— ì„¤ì • (ì‹ ë¢°)
					session.setAttribute("userId", userId);
					session.setAttribute("userGrade", userGrade);
					if (userNm != null && !userNm.isEmpty()) {
						session.setAttribute("userNm", userNm);
					}
					
					// ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
					sessionUserId = userId;
					sessionUserGrade = userGrade;
					sessionUserNm = userNm;
					
					logger.info("ì„¸ì…˜ ì„¤ì • ì™„ë£Œ - sessionUserId: {}, sessionUserGrade: {}, sessionUserNm: {}", 
							   sessionUserId, sessionUserGrade, sessionUserNm);
				}
				// 2ìˆœìœ„: DeviceVOì˜ userIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì„¤ì • (ì•±ì—ì„œ URL íŒŒë¼ë¯¸í„° ì—†ì´ ìš”ì²­í•  ë•Œ)
				else if (deviceVO.getUserId() != null && !deviceVO.getUserId().isEmpty()) {
					logger.info("DeviceVOì˜ userIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì„¤ì • - userId: {}", deviceVO.getUserId());
					
					// DeviceVOì˜ userIdë¥¼ ì„¸ì…˜ì— ì„¤ì •
					session.setAttribute("userId", deviceVO.getUserId());
					
					// userGradeê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ "U" ì„¤ì • (ì¼ë°˜ ì‚¬ìš©ì)
					String defaultUserGrade = (userGrade != null && !userGrade.isEmpty()) ? userGrade : "U";
					session.setAttribute("userGrade", defaultUserGrade);
					
					// userNmì´ ì—†ìœ¼ë©´ userIdë¥¼ ì‚¬ìš©
					String defaultUserNm = (userNm != null && !userNm.isEmpty()) ? userNm : deviceVO.getUserId();
					session.setAttribute("userNm", defaultUserNm);
					
					// ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
					sessionUserId = deviceVO.getUserId();
					sessionUserGrade = defaultUserGrade;
					sessionUserNm = defaultUserNm;
					
					logger.info("DeviceVO ê¸°ë°˜ ì„¸ì…˜ ì„¤ì • ì™„ë£Œ - sessionUserId: {}, sessionUserGrade: {}, sessionUserNm: {}", 
							   sessionUserId, sessionUserGrade, sessionUserNm);
				}
				
				// ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬
				if (!isValidSession(session)) {
					resultMap.put("resultCode", "401");
					resultMap.put("resultMessage", "ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
					logger.warn("ì„¸ì…˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ - ì¥ì¹˜ ìˆ˜ì • ì‹œë„ ì°¨ë‹¨");
					return resultMap;
				}
				
				// ë¶€ê³„ì •(B ë“±ê¸‰) ì‚¬ìš©ìëŠ” ì¥ì¹˜ ìˆ˜ì • ë¶ˆê°€
				if("B".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ë¶€ê³„ì • ì‚¬ìš©ìëŠ” ì¥ì¹˜ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ë¶€ê³„ì • ì‚¬ìš©ì ì¥ì¹˜ ìˆ˜ì • ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}
				
				// A(ê´€ë¦¬ì) ë˜ëŠ” U(ì¼ë°˜ì‚¬ìš©ì)ë§Œ ì¥ì¹˜ ìˆ˜ì • ê°€ëŠ¥
				if(!"A".equals(sessionUserGrade) && !"U".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ì¥ì¹˜ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì¥ì¹˜ ìˆ˜ì • ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}

				dataService.updateSensorInfo(deviceVO);

				resultMap.put("resultCode", "200");
				resultMap.put("resultMessage", "ì¥ì¹˜ëª… ë³€ê²½ ì„±ê³µ");
				logger.info("ì¥ì¹˜ ìˆ˜ì • ì„±ê³µ - userId: {}, sensorUuid: {}, userGrade: {}", sessionUserId, deviceVO.getSensorUuid(), sessionUserGrade);
			} catch(Exception e) {
				logger.error("Error : " + e.toString());
				e.printStackTrace();
				resultMap.put("resultCode", "999");
				resultMap.put("resultMessage", "ì¥ì¹˜ëª… ë³€ê²½ ì‹¤íŒ¨");
			}
		}

		return resultMap;
	}

	@RequestMapping(value = "/deleteSensorInfo", method = RequestMethod.POST)
	public @ResponseBody Map<String, Object> deleteSensorInfo(
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestBody DeviceVO deviceVO
			, @RequestParam(name = "userId", required = false) String userId
			, @RequestParam(name = "userGrade", required = false) String userGrade
			, @RequestParam(name = "userNm", required = false) String userNm
		) {
		Map<String, Object> resultMap = new HashMap<String, Object>();

		if(null != deviceVO) {
			try {
				// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
				HttpSession session = req.getSession();
				String sessionUserId = (String) session.getAttribute("userId");
				String sessionUserGrade = (String) session.getAttribute("userGrade");
				String sessionUserNm = (String) session.getAttribute("userNm");
				
				logger.info("=== ì„¸ì…˜ ì •ë³´ í™•ì¸ ===");
				logger.info("ì„¸ì…˜ userId: {}, userGrade: {}, userNm: {}", sessionUserId, sessionUserGrade, sessionUserNm);
				logger.info("URL íŒŒë¼ë¯¸í„° userId: {}, userGrade: {}, userNm: {}", userId, userGrade, userNm);
				logger.info("DeviceVO userId: {}, sensorUuid: {}, sensorName: {}", 
					deviceVO.getUserId(), deviceVO.getSensorUuid(), deviceVO.getSensorName());
				
				// 1ìˆœìœ„: URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ (MainControllerì™€ ë™ì¼í•œ ë°©ì‹)
				if (userId != null && !userId.isEmpty() && userGrade != null && !userGrade.isEmpty()) {
					logger.info("URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ì— ì¦‰ì‹œ ì„¤ì • - userId: {}, userGrade: {}, userNm: {}", 
							   userId, userGrade, userNm);
					
					// ì•±ì—ì„œ ì „ë‹¬ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ì— ì„¤ì • (ì‹ ë¢°)
					session.setAttribute("userId", userId);
					session.setAttribute("userGrade", userGrade);
					if (userNm != null && !userNm.isEmpty()) {
						session.setAttribute("userNm", userNm);
					}
					
					// ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
					sessionUserId = userId;
					sessionUserGrade = userGrade;
					sessionUserNm = userNm;
					
					logger.info("ì„¸ì…˜ ì„¤ì • ì™„ë£Œ - sessionUserId: {}, sessionUserGrade: {}, sessionUserNm: {}", 
							   sessionUserId, sessionUserGrade, sessionUserNm);
				}
				// 2ìˆœìœ„: DeviceVOì˜ userIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì„¤ì • (ì•±ì—ì„œ URL íŒŒë¼ë¯¸í„° ì—†ì´ ìš”ì²­í•  ë•Œ)
				else if (deviceVO.getUserId() != null && !deviceVO.getUserId().isEmpty()) {
					logger.info("DeviceVOì˜ userIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì„¤ì • - userId: {}", deviceVO.getUserId());
					
					// DeviceVOì˜ userIdë¥¼ ì„¸ì…˜ì— ì„¤ì •
					session.setAttribute("userId", deviceVO.getUserId());
					
					// userGradeê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ "U" ì„¤ì • (ì¼ë°˜ ì‚¬ìš©ì)
					String defaultUserGrade = (userGrade != null && !userGrade.isEmpty()) ? userGrade : "U";
					session.setAttribute("userGrade", defaultUserGrade);
					
					// userNmì´ ì—†ìœ¼ë©´ userIdë¥¼ ì‚¬ìš©
					String defaultUserNm = (userNm != null && !userNm.isEmpty()) ? userNm : deviceVO.getUserId();
					session.setAttribute("userNm", defaultUserNm);
					
					// ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
					sessionUserId = deviceVO.getUserId();
					sessionUserGrade = defaultUserGrade;
					sessionUserNm = defaultUserNm;
					
					logger.info("DeviceVO ê¸°ë°˜ ì„¸ì…˜ ì„¤ì • ì™„ë£Œ - sessionUserId: {}, sessionUserGrade: {}, sessionUserNm: {}", 
							   sessionUserId, sessionUserGrade, sessionUserNm);
				}

				// ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬ (ì´ì œ ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ê°€ ìˆìŒ)
				if (!isValidSession(session)) {
					logger.warn("ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ - ì¥ì¹˜ ì‚­ì œ ì‹œë„ ì°¨ë‹¨");
					resultMap.put("resultCode", "401");
					resultMap.put("resultMessage", "ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
					return resultMap;
				}
				
				// ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼
				logger.info("ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼- userId: {}", sessionUserId);
				logger.info("userGrade: {}", sessionUserGrade);
				logger.info("userNm: {}", sessionUserNm);
				
				// ë¶€ê³„ì •(B ë“±ê¸‰) ì‚¬ìš©ìëŠ” ì¥ì¹˜ ì‚­ì œ ë¶ˆê°€
				if("B".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ë¶€ê³„ì • ì‚¬ìš©ìëŠ” ì¥ì¹˜ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ë¶€ê³„ì • ì‚¬ìš©ì ì¥ì¹˜ ì‚­ì œ ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}
				
				// A(ê´€ë¦¬ì) ë˜ëŠ” U(ì¼ë°˜ì‚¬ìš©ì)ë§Œ ì¥ì¹˜ ì‚­ì œ ê°€ëŠ¥
				if(!"A".equals(sessionUserGrade) && !"U".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ì¥ì¹˜ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì¥ì¹˜ ì‚­ì œ ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}

				// ê¶Œí•œ í™•ì¸ ì™„ë£Œ - ì¥ì¹˜ ì‚­ì œ ì§„í–‰
				logger.info("ê¶Œí•œ í™•ì¸ ì™„ë£Œ - ì¥ì¹˜ ì‚­ì œ ì§„í–‰");
				
				dataService.deleteSensorInfo(deviceVO);

				Map<String, Object> param = new HashMap<String, Object>();
				param.put("userId", deviceVO.getUserId());
				param.put("setGu", "deleteDevice");

				// DB ë°ì´í„° ì‚­ì œ í›„ ì„¼ì„œ ìì²´ ì‚­ì œ ì²˜ë¦¬ ì¶”ê°€ 2023-02-24
				String payload = "ACT&name=userId&value=0";
				String sendTopic = "HBEE/" + deviceVO.getUserId() + "/TC/" + deviceVO.getSensorUuid() + "/SER";

				param.put("topicStr", sendTopic);

                String MqttServer1 = "tcp://hntnas.diskstation.me:1883";
				String MqttServer2 = "";
				String client_id = "";
				String userName = "hnt1";
				String password = "abcde";
                String topic = "#";
				String msg = "";
				String readMsg = "";

				client_id = UUID.randomUUID().toString();

				MQTT client = new MQTT(MqttServer1, client_id, userName, password);

                if(null != sendTopic && !"".equals(sendTopic) && 0 < sendTopic.length()) {
                    // ì‘ë‹µì€ DEV í† í”½ìœ¼ë¡œ ìˆ˜ì‹ í•˜ë„ë¡ êµ¬ë… í† í”½ ì„¤ì •
                    if (sendTopic.endsWith("/SER")) {
                        topic = sendTopic.substring(0, sendTopic.length() - 3) + "DEV";
                    } else {
                        topic = sendTopic;
                    }
                }
                client.init(topic, "Y"); // DEV êµ¬ë…
                client.publish(payload, 0, sendTopic); // SER ë°œí–‰
				String resultMsg = client.getMsg();
				String resultTopic = client.getRcvTopic();

				resultMap.put("resultCode", "200");
				resultMap.put("resultMessage", "ì¥ì¹˜ ì‚­ì œ ì„±ê³µ");
				resultMap.put("resultMsg", resultMsg);
				logger.info("ì¥ì¹˜ ì‚­ì œ ì„±ê³µ - userId: {}, sensorUuid: {}, userGrade: {}", sessionUserId, deviceVO.getSensorUuid(), sessionUserGrade);
			} catch(Exception e) {
				logger.error("Error : " + e.toString());
				e.printStackTrace();
				resultMap.put("resultCode", "999");
				resultMap.put("resultMessage", "ì¥ì¹˜ ì‚­ì œ ì‹¤íŒ¨");
			}
		}

		return resultMap;
	}

	@RequestMapping(value = "/data/insertSensorInfo", method = RequestMethod.POST)
	public @ResponseBody Map<String, Object> insertSensorInfo(
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestBody Map<String, Object> insertData
			, @RequestParam(name = "userId", required = false) String userId
			, @RequestParam(name = "userGrade", required = false) String userGrade
			, @RequestParam(name = "userNm", required = false) String userNm
	) {
		// ê¸°ì¡´ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬
		Map<String, Object> resultMap = new HashMap<String, Object>();

		if(null != insertData && 0 < insertData.size()) {
			try {
				// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
				HttpSession session = req.getSession();
				String sessionUserId = (String) session.getAttribute("userId");
				String sessionUserGrade = (String) session.getAttribute("userGrade");
				String sessionUserNm = (String) session.getAttribute("userNm");
				
				logger.info("ğŸš¨ğŸš¨ğŸš¨ DataController insertSensorInfo ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš¨ğŸš¨ğŸš¨");
				logger.info("ğŸš¨ğŸš¨ğŸš¨ í˜¸ì¶œ ì‹œê°„: {}", new java.util.Date());
				logger.info("ğŸš¨ğŸš¨ğŸš¨ í˜¸ì¶œì IP: {}", req.getRemoteAddr());
				logger.info("ğŸš¨ğŸš¨ğŸš¨ insertData ì „ì²´ íŒŒë¼ë¯¸í„°: {}", insertData);
				logger.info("ğŸš¨ğŸš¨ğŸš¨ ì„¸ì…˜ userId: {}, userGrade: {}, userNm: {}", sessionUserId, sessionUserGrade, sessionUserNm);
				logger.info("URL íŒŒë¼ë¯¸í„° userId: {}, userGrade: {}, userNm: {}", userId, userGrade, userNm);
				
				// 1ìˆœìœ„: URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´
				if (userId != null && !userId.isEmpty() && userGrade != null && !userGrade.isEmpty()) {
					logger.info("URL íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ì— ì¦‰ì‹œ ì„¤ì • - userId: {}, userGrade: {}, userNm: {}", 
							   userId, userGrade, userNm);
					
					session.setAttribute("userId", userId);
					session.setAttribute("userGrade", userGrade);
					if (userNm != null && !userNm.isEmpty()) {
						session.setAttribute("userNm", userNm);
					}
					
					sessionUserId = userId;
					sessionUserGrade = userGrade;
					sessionUserNm = userNm;
					
					logger.info("ì„¸ì…˜ ì„¤ì • ì™„ë£Œ - sessionUserId: {}, sessionUserGrade: {}, sessionUserNm: {}", 
							   sessionUserId, sessionUserGrade, sessionUserNm);
				}
				
				// ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬
				if (!isValidSession(session)) {
					resultMap.put("resultCode", "401");
					resultMap.put("resultMessage", "ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
					logger.warn("ì„¸ì…˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ - ì¥ì¹˜ ë“±ë¡ ì‹œë„ ì°¨ë‹¨");
					return resultMap;
				}
				
				// ë¶€ê³„ì •(B ë“±ê¸‰) ì‚¬ìš©ìëŠ” ì¥ì¹˜ ë“±ë¡ ë¶ˆê°€
				if("B".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ë¶€ê³„ì • ì‚¬ìš©ìëŠ” ì¥ì¹˜ ë“±ë¡ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ë¶€ê³„ì • ì‚¬ìš©ì ì¥ì¹˜ ë“±ë¡ ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}
				
				// A(ê´€ë¦¬ì) ë˜ëŠ” U(ì¼ë°˜ì‚¬ìš©ì)ë§Œ ì¥ì¹˜ ë“±ë¡ ê°€ëŠ¥
				if(!"A".equals(sessionUserGrade) && !"U".equals(sessionUserGrade)) {
					resultMap.put("resultCode", "403");
					resultMap.put("resultMessage", "ì¥ì¹˜ ë“±ë¡ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
					logger.warn("ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì¥ì¹˜ ë“±ë¡ ì‹œë„ ì°¨ë‹¨ - userId: {}, userGrade: {}", sessionUserId, sessionUserGrade);
					return resultMap;
				}
				
				// MainControllerì˜ insertSensorInfo ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
				if (String.valueOf(insertData.get("userId")).equals(String.valueOf(session.getAttribute("userId")))) {
					Map<String, Object> param = new HashMap<String, Object>();
					param.put("userId", String.valueOf(session.getAttribute("userId")));
					param.put("sensorUuid", String.valueOf(insertData.get("uuid")));
					param.put("sensorId", String.valueOf(insertData.get("userId")));
					param.put("sensorType", "TC");
					param.put("chartType", "none");
					param.put("instId", "hnt");
					param.put("mdfId", "hnt");
					
					// ì¥ì¹˜ ì´ë¦„ íŒŒë¼ë¯¸í„° ì¶”ê°€
					if(insertData.get("sensorName") != null && !"".equals(String.valueOf(insertData.get("sensorName")))) {
						param.put("sensorName", String.valueOf(insertData.get("sensorName")));
						logger.info("ì¥ì¹˜ ì´ë¦„ ë³€ê²½ ìš”ì²­ ê°ì§€ - sensorName: {}", insertData.get("sensorName"));
					} else {
						logger.info("sensorName íŒŒë¼ë¯¸í„°ê°€ ì—†ìŒ - insertData.get('sensorName'): {}", insertData.get("sensorName"));
					}
					
					logger.info("LoginServiceImplë¡œ ì „ë‹¬í•  param: {}", param);
					
					try {
						Map<String, Object> chkMap = new HashMap<String, Object>();
						chkMap = loginService.insertSensorInfo2(param);

						if(null != chkMap && 0 < chkMap.size()) {
							if("true".equals(String.valueOf(chkMap.get("result")))) {
								resultMap.put("resultCode", "200");
								if(chkMap.get("message") != null) {
									resultMap.put("resultMsg", String.valueOf(chkMap.get("message")));
								} else {
									resultMap.put("resultMsg", "success");
								}
							} else {
								// ì¤‘ë³µ ë“±ë¡ ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜
								resultMap.put("resultCode", "400");
								if(chkMap.get("message") != null) {
									resultMap.put("resultMsg", String.valueOf(chkMap.get("message")));
								} else {
									resultMap.put("resultMsg", "ì¥ì¹˜ ë“±ë¡ ì‹¤íŒ¨");
								}
							}
						}
					} catch (Exception e) {
						logger.error("Error : " + e.toString());
						resultMap.put("resultCode", "999");
						resultMap.put("resultMsg", "ì¥ì¹˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					}
				}
				
				logger.info("=== DataController insertSensorInfo ì™„ë£Œ ===");
				logger.info("ìµœì¢… ê²°ê³¼: {}", resultMap);
				
			} catch(Exception e) {
				logger.error("Error : " + e.toString());
				e.printStackTrace();
				resultMap.put("resultCode", "999");
				resultMap.put("resultMsg", "ì¥ì¹˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			}
		}

		return resultMap;
	}

	/**
	 * ìƒì„¸ ì„¼ì„œ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” í™”ë©´
	 * @return
	 */
    @RequestMapping(value = "/chart", method = RequestMethod.GET)
    public String chart(
            HttpServletRequest req
            , HttpServletResponse res
            , @RequestParam(name = "sensorId", required = false) String sensorId
            , @RequestParam(name = "userId", required = false) String userId
            , @RequestParam(name = "sensorUuid", required = true) String sensorUuid
            , Model model
        ) {
		
		// ë©”ì„œë“œ ì‹œì‘ ì‹œ sensorId ê°’ ë¡œê¹…
		logger.info("DataController - ë©”ì„œë“œ ì‹œì‘ sensorId: " + sensorId);
		String result = "chart/chart";

        HttpSession session = req.getSession();

        // ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬: ì„¸ì…˜ì´ ì—†ê±°ë‚˜ í•„ìˆ˜ ì†ì„± ëˆ„ë½ ì‹œ ë³µêµ¬ ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        if (!isValidSession(session)) {
            String restoreUserId = (String) session.getAttribute("loginUserId");
            if (restoreUserId == null || restoreUserId.isEmpty()) {
                restoreUserId = userId; // URL íŒŒë¼ë¯¸í„° ë³´ì™„(ì„¸ì…˜ ìš°ì„  ì •ì±…ì€ ìœ ì§€)
            }
            if (restoreUserId != null && !restoreUserId.isEmpty()) {
                session.setAttribute("userId", restoreUserId);
            }
            if (!isValidSession(session)) {
                logger.warn("DataController.chart - ì„¸ì…˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ(ë³µêµ¬ ì‹¤íŒ¨). ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸");
                return "redirect:/login/login";
            }
        }

        if(null != session) {
            // URL userId íŒŒë¼ë¯¸í„°ëŠ” ë¬´ì‹œí•˜ê³  ì„¸ì…˜ ê°’ ìš°ì„ 
            userId = String.valueOf(session.getAttribute("userId"));
            model.addAttribute("userId", userId);
            model.addAttribute("loginUserId", userId);
            model.addAttribute("userNm", String.valueOf(session.getAttribute("userNm")));
            model.addAttribute("userGrade", String.valueOf(session.getAttribute("userGrade")));
            // ì„¸ì…˜ ë³´ì™„: íŒŒë¼ë¯¸í„° userIdê°€ ìˆê³  ì„¸ì…˜ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì„¤ì •
            if ((session.getAttribute("userId") == null || "".equals(String.valueOf(session.getAttribute("userId")))) && userId != null && !userId.isEmpty()) {
                session.setAttribute("userId", userId);
            }

            // userIdì™€ sensorUuidë§Œìœ¼ë¡œ ì²˜ë¦¬ ì‹œì‘ (sensorIdëŠ” DBì—ì„œ ë³´ì •)
            if(null != userId && !"".equals(userId) && null != sensorUuid && !"".equals(sensorUuid)) {
                List<Map<String, Object>> dailyList = new ArrayList<Map<String, Object>>();
                List<Map<String, Object>> monthlyList = new ArrayList<Map<String, Object>>();
                List<Map<String, Object>> yearlyList = new ArrayList<Map<String, Object>>();

				List<String> daily = new ArrayList<String>();
				List<String> monthly = new ArrayList<String>();
				List<String> yearly = new ArrayList<String>();

                String topicStr = "";
				String sensorName = "";
				UserInfo user = new UserInfo();

                Map<String, Object> userInfo = new HashMap<String, Object>();
                userInfo = adminService.getUserInfo(userId, sensorUuid);

				if(null != userInfo && !"".equals(userInfo)) {
                    Object userObj = userInfo.get("userInfo");
                    if (userObj instanceof UserInfo) {
                        user = (UserInfo) userObj;
                    } else if (userObj == null) {
                        logger.warn("DataController - userInfo.userInfo ê°€ null ì…ë‹ˆë‹¤. userId: {}, sensorUuid: {}", userId, sensorUuid);
                    } else {
                        logger.warn("DataController - userInfo.userInfo íƒ€ì…ì´ UserInfoê°€ ì•„ë‹™ë‹ˆë‹¤: {}", userObj.getClass());
                    }
                    Map<String, Object> sensor = (Map<String, Object>) userInfo.get("sensorInfo");
                    if (sensor != null && !sensor.isEmpty()) {
                        sensorName = String.valueOf(sensor.get("sensor_name"));
                        // ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì IDë¡œ sensorId ì„¤ì •
                        sensorId = String.valueOf(sensor.get("sensor_id"));
                        // ì£¼ì˜: ì„œë²„ì¸¡ MQTT í´ë¼ì´ì–¸íŠ¸ëŠ” ì™€ì¼ë“œì¹´ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
                        topicStr = "HBEE/" + sensorId + "/" + String.valueOf(sensor.get("sensor_type")) + "/" + String.valueOf(sensor.get("sensor_uuid")) + "/SER";
                        if (topicStr.contains("+") || topicStr.contains("#")) {
                            logger.error("DataController - ìœ íš¨í•˜ì§€ ì•Šì€ í† í”½ ìƒì„± ê°ì§€(ì™€ì¼ë“œì¹´ë“œ í¬í•¨): {}", topicStr);
                            topicStr = topicStr.replace("+", "").replace("#", "");
                        }
						
						// ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
						logger.info("DataController - URL íŒŒë¼ë¯¸í„° sensorId: " + req.getParameter("sensorId"));
						logger.info("DataController - ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì sensorId: " + sensorId);
						logger.info("DataController - topicStr: " + topicStr);
						
						// ì˜¬ë°”ë¥¸ sensorId ì €ì¥ ì™„ë£Œ
					}
				}

                Map<String, Object> param = new HashMap<String, Object>();
                // ë¶€ê³„ì •ì´ ë©”ì¸ ê³„ì •ì˜ ì¥ì¹˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” user_idë¥¼ sensor_idì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
                param.put("userId", sensorId);  // ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì ID ì‚¬ìš©
                param.put("sensorId", sensorId);
                param.put("sensorUuid", sensorUuid);

				try {
					// ì¼ê°„ ë°ì´í„° ì¡°íšŒ
					param.put("gu", "d");
					dailyList = dataService.selectSensorData(param);

					if(null != dailyList && 0 < dailyList.size()) {
						for(int i=0; i < dailyList.size(); i++) {
							daily.add(dailyList.get(i).get("inst_dtm") + "^" + dailyList.get(i).get("sensor_value"));
						}
					}

                    // ì„±ëŠ¥ ìµœì í™”: ì´ˆê¸° ì§„ì… ì‹œ ì›”ê°„/ì—°ê°„ ì§‘ê³„ëŠ” ë¯¸ë¦¬ ì¡°íšŒí•˜ì§€ ì•ŠìŒ
                    String prefetch = req.getParameter("prefetch");
                    boolean prefetchAll = "all".equalsIgnoreCase(prefetch);

                    if (prefetchAll) {
                        // ì›”ê°„ ë°ì´í„° ì¡°íšŒ
                        param.remove("gu");
                        param.put("gu", "w");
                        // ê¸°ê°„ íŒŒë¼ë¯¸í„° ì ìš© (ìˆì„ ë•Œë§Œ)
                        String startDateParam = req.getParameter("startDate");
                        String endDateParam = req.getParameter("endDate");
                        if(startDateParam != null && !startDateParam.isEmpty() && endDateParam != null && !endDateParam.isEmpty()) {
                            param.put("setDate1", startDateParam.replace("-", "") + "000000");
                            param.put("setDate2", endDateParam.replace("-", "") + "235959");
                            model.addAttribute("startDate", req.getParameter("startDate"));
                            model.addAttribute("endDate", req.getParameter("endDate"));
                        }
                        monthlyList = dataService.selectSensorData(param);

                        if(null != monthlyList && 0 < monthlyList.size()) {
                            for(int i=0; i < monthlyList.size(); i++) {
                                monthly.add(monthlyList.get(i).get("inst_dtm") + "^" + monthlyList.get(i).get("sensor_value"));
                            }
                        }

                        // ì—°ê°„ ë°ì´í„° ì¡°íšŒ
                        param.remove("gu");
                        param.put("gu", "y");
                        yearlyList = dataService.selectSensorData(param);

                        if(null != yearlyList && 0 < yearlyList.size()) {
                            for(int i=0; i < yearlyList.size(); i++) {
                                yearly.add(yearlyList.get(i).get("inst_dtm") + "^" + yearlyList.get(i).get("sensor_value"));
                            }
                        }
                    }

					String todayStr = "";
					Date today = new Date();
					SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
					todayStr = sdf.format(today);

					// ëª¨ë¸ ì†ì„± ì„¤ì • ì „ ë””ë²„ê¹… ë¡œê·¸
					logger.info("DataController - ëª¨ë¸ì— ì„¤ì •í•  sensorId: " + sensorId);
					
                    // ì„¸ì…˜ì˜ sensorIdë¥¼ ì˜¬ë°”ë¥¸ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ë„ê°€ë“œ)
                    if (sensorId != null && !"".equals(sensorId)) {
                        session.setAttribute("sensorId", sensorId);
                        logger.info("DataController - ì„¸ì…˜ sensorId ì—…ë°ì´íŠ¸: " + sensorId);
                    } else {
                        logger.warn("DataController - sensorId ê°€ null/ë¹ˆ ê°’ì…ë‹ˆë‹¤. userId: {}, sensorUuid: {}", userId, sensorUuid);
                    }
					
                    model.addAttribute("userId", userId);
                    model.addAttribute("sensorId", sensorId);
					model.addAttribute("sensorUuid", sensorUuid);
					
					// ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ - ëª¨ë¸ì— ì„¤ì •ë˜ëŠ” ê°’ í™•ì¸
					logger.info("DataController - model.addAttribute sensorId: " + sensorId);
					logger.info("DataController - model.addAttribute userId: " + userId);
                    model.addAttribute("sensorName", sensorName);
                    model.addAttribute("dailyList", dailyList);
					model.addAttribute("monthlyList", monthlyList);
					model.addAttribute("yearlyList", yearlyList);
					model.addAttribute("topicStr", topicStr);
					model.addAttribute("daily", daily);
					model.addAttribute("monthly", monthly);
					model.addAttribute("yearly", yearly);
					model.addAttribute("todayStr", todayStr);

                    // ì‚¬ì´ë“œë°” ë°ì´í„° ì¶”ê°€ (ì„¸ì…˜ userId ìš°ì„  ë³´ì¥)
                    String sessionUserIdEff = (String) session.getAttribute("userId");
                    String effectiveUserId = (sessionUserIdEff != null && !sessionUserIdEff.isEmpty()) ? sessionUserIdEff : userId;
                    commonController.addSidebarData(effectiveUserId, model, session);
                    // ì„¸ì…˜ì— userNmì´ ì—†ì„ ë•Œ DB ì¡°íšŒê°’(user)ë¡œ ë³´ì™„
                    Object sessionUserNmObj = session.getAttribute("userNm");
                    if ((sessionUserNmObj == null || String.valueOf(sessionUserNmObj).isEmpty()) && user != null) {
                        model.addAttribute("userNm", user.getUserNm());
                        model.addAttribute("userGrade", user.getUserGrade());
                    }
                    model.addAttribute("sensorName", sensorName);
				} catch(Exception e) {
					logger.error("Error : " + e.toString());
					e.printStackTrace();
				}
			} else {
				logger.error("Error : ë°ì´í„° ì¡°íšŒì— í•„ìš”í•œ í•„ìˆ˜ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
			}
		} else {
			result = "redirect:/login/login";
		}

		return result;
	}

	@RequestMapping(value = "/excelDownload", method = RequestMethod.GET)
	public void excelDownload (
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestParam(name = "sensorId", required = true) String sensorId
			, @RequestParam(name = "userId", required = true) String userId
			, @RequestParam(name = "sensorUuid", required = true) String sensorUuid
			, @RequestParam(name = "setDate", required = false) String setDate
			, @RequestParam(name = "startDate", required = false) String startDate
			, @RequestParam(name = "endDate", required = false) String endDate
			, @RequestParam(name = "sensorName", required = false) String sensorName
		) throws IOException {

		logger.info("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘ - sensorId: {}, userId: {}, sensorUuid: {}, sensorName: {}", 
			sensorId, userId, sensorUuid, sensorName);

		HttpSession session = req.getSession();

		if(null != session) {
			if(null != userId && !"".equals(userId)) {

			} else {
				userId = String.valueOf(session.getAttribute("userId"));
			}

			if(null != userId && !"".equals(userId) && null != sensorId && !"".equals(sensorId) && null != sensorUuid && !"".equals(sensorUuid)) {
				String todayStr = "";
				String setDate1 = "";
				String setDate2 = "";

				if(null != setDate && !"".equals(setDate) && 0 < setDate.length()) {
					todayStr = setDate;
					if(setDate.contains("-")) {
						setDate = setDate.replace("-", "");
					}
					setDate1 = setDate + "000000";
					setDate2 = setDate + "235959";
				} else {
					Date today = new Date();
					SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
					todayStr = sdf.format(today);
				}

				if(null != startDate && !"".equals(startDate) && 0 < startDate.length()) {
					if(startDate.contains("-")) {
						startDate = startDate.replace("-", "");
					}
					setDate1 = startDate + "000000";
				}

				if(null != endDate && !"".equals(endDate) && 0 < endDate.length()) {
					if(endDate.contains("-")) {
						endDate = endDate.replace("-", "");
					}
					setDate2 = endDate + "235959";
				}

				logger.info("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ íŒŒë¼ë¯¸í„° - todayStr: {}, setDate1: {}, setDate2: {}", 
					todayStr, setDate1, setDate2);

				res.setHeader("Content-Disposition", "attachment;filename=report_"+todayStr+".xls");
				res.setContentType("application/vnd.ms-excel");

				List<Map<String, Object>> dailyList = new ArrayList<Map<String, Object>>();
				List<Map<String, Object>> monthlyList = new ArrayList<Map<String, Object>>();
				List<Map<String, Object>> yearlyList = new ArrayList<Map<String, Object>>();

				List<String> daily = new ArrayList<String>();
				List<String> monthly = new ArrayList<String>();
				List<String> yearly = new ArrayList<String>();

				List<String> header = new ArrayList<String>();
				List<String> header2 = new ArrayList<String>();
				List<String> header3 = new ArrayList<String>();

				// === ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì ID ì¡°íšŒ (ì°¨íŠ¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§) ===
				String actualSensorId = sensorId;  // ê¸°ë³¸ê°’
				Map<String, Object> userInfo = new HashMap<String, Object>();
				userInfo = adminService.getUserInfo(userId, sensorUuid);

				if(null != userInfo && !"".equals(userInfo)) {
					Map<String, Object> sensor = (Map<String, Object>) userInfo.get("sensorInfo");
					if (null != sensor && 0 < sensor.size()) {
						// ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì IDë¡œ sensorId ì„¤ì •
						actualSensorId = String.valueOf(sensor.get("sensor_id"));
						logger.info("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ - URL íŒŒë¼ë¯¸í„° sensorId: {}", sensorId);
						logger.info("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ - ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì sensorId: {}", actualSensorId);
					}
				}

				Map<String, Object> param = new HashMap<String, Object>();
				// ë¶€ê³„ì •ì´ ë©”ì¸ ê³„ì •ì˜ ì¥ì¹˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” user_idë¥¼ sensor_idì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
				param.put("userId", actualSensorId);  // ì‹¤ì œ ì¥ì¹˜ ì†Œìœ ì ID ì‚¬ìš©
				param.put("sensorId", actualSensorId);
				param.put("sensorUuid", sensorUuid);
				param.put("setDate", setDate);
				param.put("setDate1", setDate1);
				param.put("setDate2", setDate2);

				logger.info("ë°ì´í„° ì¡°íšŒ íŒŒë¼ë¯¸í„° - param: {}", param);

				try {
					// ì¼ê°„ ë°ì´í„° ì¡°íšŒ
					param.put("gu", "d");
					dailyList = dataService.selectSensorData(param);
					logger.info("ì¼ê°„ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ - ë°ì´í„° ìˆ˜: {}, sensorUuid: {}", 
						dailyList != null ? dailyList.size() : 0, sensorUuid);

					// ë°ì´í„° ìƒ˜í”Œ ë¡œê¹…
					if(dailyList != null && !dailyList.isEmpty()) {
						logger.info("ì¼ê°„ ë°ì´í„° ìƒ˜í”Œ - ì²« ë²ˆì§¸ ë°ì´í„°: {}", dailyList.get(0));
					}

					header.add("00:00");
					header.add("00:30");
					header.add("01:00");
					header.add("01:30");
					header.add("02:00");
					header.add("02:30");
					header.add("03:00");
					header.add("03:30");
					header.add("04:00");
					header.add("04:30");
					header.add("05:00");
					header.add("05:30");
					header.add("06:00");
					header.add("06:30");
					header.add("07:00");
					header.add("07:30");
					header.add("08:00");
					header.add("08:30");
					header.add("09:00");
					header.add("09:30");
					header.add("10:00");
					header.add("10:30");
					header.add("11:00");
					header.add("11:30");
					header.add("12:00");
					header.add("12:30");
					header.add("13:00");
					header.add("13:30");
					header.add("14:00");
					header.add("14:30");
					header.add("15:00");
					header.add("15:30");
					header.add("16:00");
					header.add("16:30");
					header.add("17:00");
					header.add("17:30");
					header.add("18:00");
					header.add("18:30");
					header.add("19:00");
					header.add("19:30");
					header.add("20:00");
					header.add("20:30");
					header.add("21:00");
					header.add("21:30");
					header.add("22:00");
					header.add("22:30");
					header.add("23:00");
					header.add("23:30");

					// ì›”ê°„ ë°ì´í„° ì¡°íšŒ
					param.remove("gu");
					param.put("gu", "w");
					monthlyList = dataService.selectSensorData(param);
					logger.info("ì›”ê°„ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ - ë°ì´í„° ìˆ˜: {}", monthlyList != null ? monthlyList.size() : 0);

					if(null != monthlyList && 0 < monthlyList.size()) {
						for(int i =0; i < monthlyList.size(); i++) {
							monthly.add(String.valueOf(monthlyList.get(i).get("sensor_value")));
							header2.add(String.valueOf(monthlyList.get(i).get("inst_dtm")));
						}
					}

					// ì—°ê°„ ë°ì´í„° ì¡°íšŒ
					param.remove("gu");
					param.put("gu", "y");
					yearlyList = dataService.selectSensorData(param);
					logger.info("ì—°ê°„ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ - ë°ì´í„° ìˆ˜: {}", yearlyList != null ? yearlyList.size() : 0);

					if(null != yearlyList && 0 < yearlyList.size()) {
						for(int i =0; i < yearlyList.size(); i++) {
							yearly.add(String.valueOf(yearlyList.get(i).get("sensor_value")));
							header3.add(String.valueOf(yearlyList.get(i).get("inst_dtm")));
						}
					}

					logger.info("ì—‘ì…€ íŒŒì¼ ìƒì„± ì‹œì‘ - ì¼ê°„: {}, ì›”ê°„: {}, ì—°ê°„: {}", 
						dailyList != null ? dailyList.size() : 0,
						monthlyList != null ? monthlyList.size() : 0,
						yearlyList != null ? yearlyList.size() : 0);

					ByteArrayInputStream stream = ExcelUtils.createDataExcel(header, header2, header3, dailyList, monthlyList, yearlyList, sensorName);
					IOUtils.copy(stream, res.getOutputStream());
					
					logger.info("ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ");
				} catch (Exception e) {
					logger.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {}", e.getMessage(), e);
					e.printStackTrace();
				}
			}
		}

	}
	
	@RequestMapping(value = "/getDailyData", method = RequestMethod.POST)
	public @ResponseBody Map<String, Object> getDailyData(
			HttpServletRequest req
			, HttpServletResponse res
			, @RequestParam(name = "sensorId", required = true) String sensorId
			, @RequestParam(name = "userId", required = true) String userId
			, @RequestParam(name = "sensorUuid", required = true) String sensorUuid
			, @RequestParam(name = "startDate", required = false) String startDate
			, @RequestParam(name = "endDate", required = true) String endDate
	) {
		Map<String, Object> resultMap = new HashMap<String, Object>();
		
		try {
			Map<String, Object> param = new HashMap<String, Object>();
			// ì˜¨ë„ë°ì´í„°ëŠ” sensor_uuidì—ë§Œ ì¢…ì†ë¨
			param.put("sensorUuid", sensorUuid);
			
			// ë‚ ì§œ íŒŒë¼ë¯¸í„° ì¶”ê°€ (endDateë§Œ ì‚¬ìš©)
			if(endDate != null && !endDate.isEmpty()) {
				param.put("startDateTime", endDate + " 00:00:00");
				param.put("endDateTime", endDate + " 23:59:59");
			}
			
			// ì¼ê°„ ë°ì´í„° ì¡°íšŒ
			param.put("gu", "d");
			
			List<Map<String, Object>> dailyList = dataService.selectSensorData(param);
			
			List<String> daily = new ArrayList<String>();
			
			if(null != dailyList && 0 < dailyList.size()) {
				for(int i=0; i < dailyList.size(); i++) {
					daily.add(dailyList.get(i).get("inst_dtm") + "^" + dailyList.get(i).get("sensor_value"));
				}
			}
			
			// ê²°ê³¼ ë°ì´í„°ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
			String dailyData = String.join(",", daily);
			
			resultMap.put("resultCode", "200");
			resultMap.put("resultMessage", "ë°ì´í„° ì¡°íšŒ ì„±ê³µ");
			resultMap.put("dailyData", dailyData);
			
		} catch(Exception e) {
			logger.error("Error : " + e.toString());
			e.printStackTrace();
			resultMap.put("resultCode", "500");
			resultMap.put("resultMessage", "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
		}
		
		return resultMap;
	}
}
