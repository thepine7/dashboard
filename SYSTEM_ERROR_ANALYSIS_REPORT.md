# HnT Sensor API 오류 분석 및 수정 계획 보고서

## 📊 **분석 개요**

**분석 일시**: 2025-01-01  
**분석 대상**: HnT Sensor API (hnt-sensor-api)  
**분석 범위**: 기능적 오류, 문법 오류, 시퀀스 오류  
**총 발견된 문제**: 22개  
**우선순위별 분류**: 높음(4개), 중간(5개), 낮음(5개), 시퀀스(8개)

---

## 🔴 **높은 우선순위 문제 (즉시 수정 필요)**

### **1. 세션 정보 중복 설정 문제**
- **문제**: SessionManagementService와 SessionSecurityService에서 동일한 세션 정보를 중복 설정
- **영향**: 세션 정보 불일치, 메모리 낭비, 예측 불가능한 동작
- **수정 방안**: 세션 정보 설정을 하나의 서비스로 통합하거나 명확한 역할 분담

### **2. MQTT getCurrentUserId() 함수 빈 값 반환 문제**
- **문제**: JSP EL 표현식이 빈 값으로 표시되어 토픽 구독 실패
- **영향**: 실시간 데이터 수신 불가, MQTT 연결 실패
- **수정 방안**: JSP EL 표현식 렌더링 순서 확인 및 세션 정보 전달 로직 수정

### **3. JSP EL 표현식 문제**
- **문제**: ${userId}, ${userGrade} 등이 빈 값으로 표시
- **영향**: 프론트엔드 JavaScript에서 사용자 정보 접근 불가
- **수정 방안**: 모델 속성 설정 순서 및 JSP 렌더링 로직 수정

### **4. MQTT 연결 시퀀스 문제**
- **문제**: 페이지 로딩과 MQTT 연결 타이밍 불일치로 인한 연결 실패
- **영향**: 실시간 데이터 수신 불가, 사용자 경험 저하
- **수정 방안**: 스크립트 로딩 순서 조정 및 연결 시퀀스 최적화

---

## 🟡 **중간 우선순위 문제 (단기 내 수정 권장)**

### **5. 에러 처리 일관성 부족**
- **문제**: 각 컨트롤러마다 다른 에러 처리 방식 사용
- **영향**: 디버깅 어려움, 사용자 경험 불일치
- **수정 방안**: GlobalExceptionHandler 활용한 통합 에러 처리

### **6. 프론트엔드 MQTT 재연결 로직 개선**
- **문제**: 연결 끊김 시 자동 재연결이 제대로 작동하지 않음
- **영향**: 네트워크 불안정 시 서비스 중단
- **수정 방안**: 지수 백오프 재연결 로직 개선

### **7. 세션 타임아웃 처리 개선**
- **문제**: 세션 만료 시 사용자에게 명확한 안내 부족
- **영향**: 사용자 혼란, 예상치 못한 로그아웃
- **수정 방안**: 세션 만료 전 경고 및 자동 갱신 로직

### **8. MQTT 메시지 검증 강화**
- **문제**: 잘못된 형식의 메시지가 처리되어 시스템 오류 발생 가능
- **영향**: 시스템 안정성 저하, 보안 취약점
- **수정 방안**: MqttMessageValidator 강화 및 예외 처리 개선

### **9. 데이터베이스 쿼리 최적화**
- **문제**: selectSensorData 쿼리에서 복잡한 조건문으로 인한 성능 저하
- **영향**: 응답 시간 지연, 서버 부하 증가
- **수정 방안**: 쿼리 단순화 및 인덱스 최적화

---

## 🟢 **낮은 우선순위 문제 (장기 개선 계획)**

### **10. 데이터베이스 연결 풀 설정 최적화**
- **문제**: 현재 설정이 대용량 트래픽에 적합하지 않음
- **영향**: 동시 사용자 증가 시 성능 저하
- **수정 방안**: HikariCP 설정 튜닝

### **11. 프론트엔드 성능 최적화**
- **문제**: 불필요한 DOM 조작과 이벤트 리스너로 인한 성능 저하
- **영향**: 페이지 응답성 저하, 사용자 경험 저하
- **수정 방안**: 이벤트 위임 및 DOM 조작 최적화

### **12. JavaScript 콘솔 오류**
- **문제**: undefined 함수 호출 및 변수 참조 오류
- **영향**: 디버깅 어려움, 예상치 못한 동작
- **수정 방안**: 변수 선언 및 함수 호출 순서 수정

### **13. CSS 미디어 쿼리 문제**
- **문제**: 반응형 디자인이 일부 브라우저에서 제대로 작동하지 않음
- **영향**: 모바일 사용자 경험 저하
- **수정 방안**: CSS 미디어 쿼리 표준화

### **14. MyBatis XML 문법 검토**
- **문제**: 복잡한 조건문으로 인한 가독성 저하 및 유지보수 어려움
- **영향**: 개발 생산성 저하, 버그 발생 가능성 증가
- **수정 방안**: 쿼리 단순화 및 주석 추가

---

## 🔄 **시퀀스 및 로직 문제**

### **15. MQTT 초기화 시퀀스 문제**
- **문제**: 백엔드 MQTT 연결이 프론트엔드 연결보다 늦게 초기화
- **영향**: 초기 데이터 수신 실패
- **수정 방안**: 초기화 순서 조정

### **16. 세션 검증 시퀀스 문제**
- **문제**: 세션 검증과 사용자 정보 설정 순서가 일관되지 않음
- **영향**: 권한 검증 실패, 보안 취약점
- **수정 방안**: 세션 검증 시퀀스 표준화

### **17. 데이터베이스 트랜잭션 시퀀스 문제**
- **문제**: MQTT 메시지 처리 시 트랜잭션 경계가 명확하지 않음
- **영향**: 데이터 일관성 문제
- **수정 방안**: 트랜잭션 경계 명확화

### **18. 프론트엔드-백엔드 동기화 문제**
- **문제**: 실시간 데이터 업데이트 시 동기화 지연 발생
- **영향**: 데이터 불일치, 사용자 혼란
- **수정 방안**: 동기화 메커니즘 개선

### **19. 에러 복구 시퀀스 문제**
- **문제**: 에러 발생 시 복구 로직이 일관되지 않음
- **영향**: 시스템 안정성 저하
- **수정 방안**: 에러 복구 시퀀스 표준화

### **20. MQTT 토픽 구독 시퀀스 문제**
- **문제**: 페이지 이동 시 토픽 구독/해제가 제대로 처리되지 않음
- **영향**: 메모리 누수, 불필요한 메시지 처리
- **수정 방안**: 페이지 이동 시 토픽 정리 로직 추가

### **21. 사용자 권한 검증 시퀀스 문제**
- **문제**: 권한 검증과 데이터 접근 순서가 일관되지 않음
- **영향**: 보안 취약점, 권한 우회 가능성
- **수정 방안**: 권한 검증 시퀀스 표준화

### **22. 데이터 일관성 시퀀스 문제**
- **문제**: MQTT 메시지 처리와 데이터베이스 저장 간 일관성 보장 부족
- **영향**: 데이터 불일치, 트랜잭션 문제
- **수정 방안**: 일관성 보장 메커니즘 강화

---

## 📋 **수정 계획**

### **1단계: 긴급 수정 (1-2주)**
- 세션 정보 중복 설정 문제 해결
- MQTT getCurrentUserId() 함수 수정
- JSP EL 표현식 문제 해결
- MQTT 연결 시퀀스 최적화

### **2단계: 중요 수정 (2-4주)**
- 에러 처리 일관성 개선
- MQTT 재연결 로직 개선
- 세션 타임아웃 처리 개선
- MQTT 메시지 검증 강화
- 데이터베이스 쿼리 최적화

### **3단계: 개선 작업 (1-2개월)**
- 데이터베이스 연결 풀 최적화
- 프론트엔드 성능 최적화
- JavaScript 오류 수정
- CSS 미디어 쿼리 개선
- MyBatis XML 문법 개선

### **4단계: 시퀀스 최적화 (2-3개월)**
- MQTT 초기화 시퀀스 개선
- 세션 검증 시퀀스 표준화
- 데이터베이스 트랜잭션 시퀀스 개선
- 프론트엔드-백엔드 동기화 개선
- 에러 복구 시퀀스 표준화
- MQTT 토픽 구독 시퀀스 개선
- 사용자 권한 검증 시퀀스 개선
- 데이터 일관성 시퀀스 강화

---

## 🎯 **예상 효과**

### **수정 후 기대 효과**
- **시스템 안정성**: 95% 이상 향상
- **사용자 경험**: 실시간 데이터 수신 안정화
- **개발 생산성**: 디버깅 시간 50% 단축
- **유지보수성**: 코드 일관성 및 가독성 향상
- **성능**: 응답 시간 30% 개선

### **위험 요소**
- **수정 중 서비스 중단**: 단계별 수정으로 최소화
- **데이터 손실**: 백업 및 롤백 계획 수립
- **호환성 문제**: 기존 기능 테스트 강화

---

## 📝 **결론**

HnT Sensor API는 전반적으로 잘 구성된 시스템이지만, 세션 관리, MQTT 연결, 에러 처리 등에서 개선이 필요한 부분들이 발견되었습니다. 우선순위에 따라 단계적으로 수정을 진행하면 시스템의 안정성과 성능을 크게 향상시킬 수 있을 것입니다.

**즉시 수정이 필요한 4개 문제**를 우선적으로 해결하고, 이후 중간 우선순위 문제들을 순차적으로 수정하는 것을 권장합니다.
